# 测试文档 - 最酷体育爬虫实现 - 2026年2月17日

## 一、测试目标

验证最酷体育（Zuicool）爬虫的完整实现，包括：
1. 使用 Cheerio 进行 HTML 解析
2. 实现增量更新逻辑（基于 content hash）
3. 实现错误重试机制（带退避策略）
4. 数据提取的准确性和完整性

## 二、测试环境准备

### 2.1 环境变量配置

必需的环境变量：
```bash
DATABASE_URL=postgresql://...
ADMIN_API_TOKEN=your-admin-token
```

可选的环境变量：
```bash
# 启用同步调度器（开发环境测试）
SYNC_SCHEDULER_ENABLED=true

# AI 兜底提取（可选）
AI_API_KEY=your-api-key
AI_MODEL=deepseek-chat
AI_ENABLE_FALLBACK=true

# Discovery 搜索（可选）
BRAVE_API_KEY=your-brave-api-key
```

### 2.2 数据库初始化

```bash
# 1. 确保数据库 schema 已更新
npm run db:ensure

# 2. 导入 sources 配置
npm run config:import

# 3. （可选）导入种子数据
npm run db:seed
```

### 2.3 启动应用

```bash
# 开发模式
npm run dev

# 访问管理后台
# http://localhost:5000/admin/data
```

## 三、测试检测点

### 3.1 配置验证测试

#### 测试点 1.1：Sources 配置导入
**目的**：验证最酷体育数据源已正确导入

**步骤**：
1. 打开 `/admin/data` -> Sources Tab
2. 查找 "最酷体育（Zuicool）" 数据源

**预期结果**：
- ✓ 数据源存在
- ✓ `type` 为 `platform`
- ✓ `strategy` 为 `HTML`
- ✓ `baseUrl` 为 `https://www.zuicool.com`
- ✓ `priority` 为 `90`
- ✓ `retryMax` 为 `3`
- ✓ `retryBackoffSeconds` 为 `30`
- ✓ `requestTimeoutMs` 为 `15000`
- ✓ `minIntervalSeconds` 为 `21600`（6小时）

#### 测试点 1.2：Discovery 配置
**目的**：验证列表发现配置已正确设置

**步骤**：
1. 在 Sources Tab 中点击编辑 "最酷体育（Zuicool）"
2. 查看 config JSON

**预期结果**：
```json
{
  "discovery": {
    "list": {
      "itemLink": {
        "selector": "a.event-a[href*='/event/']",
        "attr": "href"
      }
    }
  },
  "extract": {
    "raceDate": {
      "selector": ".event-date, [class*='date']",
      "attr": "text",
      "regex": "(20\\d{2})-(\\d{1,2})-(\\d{1,2})"
    },
    "registrationStatus": {
      "selector": ".registration-status, [class*='status']",
      "attr": "text"
    },
    "registrationUrl": {
      "selector": "a[href*='register'], a[href*='signup']",
      "attr": "href"
    }
  }
}
```

### 3.2 Cheerio HTML 解析测试

#### 测试点 2.1：列表页链接发现
**目的**：验证能够从列表页提取赛事详情链接

**步骤**：
1. 打开 `/admin/data` -> 绑定/发现 Tab
2. 选择 "平台列表发现（HTML）"
3. Source 选择 "最酷体育（Zuicool）"
4. List URL 输入 `https://www.zuicool.com/events`
5. 点击 "发现链接"

**预期结果**：
- ✓ 返回多个赛事详情链接
- ✓ 链接格式为 `https://www.zuicool.com/event/XXXXX`
- ✓ 每个链接包含标题（title）
- ✓ 无 JavaScript 错误

#### 测试点 2.2：详情页数据提取
**目的**：验证能够从详情页提取赛事信息

**步骤**：
1. 从发现的链接中选择一个
2. 点击 "作为绑定 URL"
3. 在 "Bind Marathon Source" 中：
   - 选择一个已存在的 Marathon（或创建新的）
   - 选择 Source 为 "最酷体育（Zuicool）"
   - 使用刚才的 URL
   - 勾选 `isPrimary`（如果是主要数据源）
4. 点击 "Bind"

**预期结果**：
- ✓ 绑定成功
- ✓ 在 Marathon Sources 列表中出现新记录
- ✓ `sourceUrl` 正确
- ✓ `isPrimary` 状态正确

### 3.3 增量更新逻辑测试

#### 测试点 3.1：首次抓取
**目的**：验证首次抓取能够正确获取和存储数据

**步骤**：
1. 在 Sources Tab 中启用 "最酷体育（Zuicool）"（设置 `isActive=true`）
2. 在 同步 Tab 中点击 "立即同步一次"
3. 等待同步完成（观察状态变化）

**预期结果**：
- ✓ 同步状态显示 "success"
- ✓ `newCount` 或 `updatedCount` > 0
- ✓ 在 raw_crawl_data 表中有新记录
- ✓ `contentHash` 已计算并存储
- ✓ `marathonSources.lastHash` 已更新
- ✓ `marathonSources.lastCheckedAt` 已更新
- ✓ `marathonSources.nextCheckAt` 已设置（当前时间 + 6小时）

**验证数据库**：
```sql
-- 查看同步记录
SELECT * FROM marathon_sync_runs 
WHERE source_id = (SELECT id FROM sources WHERE name = '最酷体育（Zuicool）')
ORDER BY started_at DESC LIMIT 5;

-- 查看 raw 数据
SELECT id, content_hash, status, http_status, fetched_at 
FROM raw_crawl_data 
WHERE source_id = (SELECT id FROM sources WHERE name = '最酷体育（Zuicool）')
ORDER BY fetched_at DESC LIMIT 5;

-- 查看 marathon_sources 状态
SELECT last_checked_at, last_hash, last_http_status, next_check_at, last_error
FROM marathon_sources 
WHERE source_id = (SELECT id FROM sources WHERE name = '最酷体育（Zuicool）');
```

#### 测试点 3.2：重复抓取（内容未变化）
**目的**：验证内容未变化时不会重复存储

**步骤**：
1. 等待至少 1 秒（确保 hash 计算一致）
2. 在 同步 Tab 中再次点击 "立即同步一次"
3. 观察同步结果

**预期结果**：
- ✓ 同步状态显示 "success"
- ✓ `unchangedCount` = 1
- ✓ `updatedCount` = 0
- ✓ raw_crawl_data 表中**没有**新增记录（因为 hash 相同）
- ✓ `marathonSources.lastHash` 保持不变
- ✓ `marathonSources.nextCheckAt` 重新设置

#### 测试点 3.3：内容变化检测
**目的**：验证内容变化时能够检测并更新

**说明**：此测试需要等待网站实际更新，或使用测试环境模拟。在生产环境中，观察以下指标：

**预期行为**：
- ✓ 当远程内容发生变化时，contentHash 不同
- ✓ 新的 raw_crawl_data 记录被创建
- ✓ `lastHash` 更新为新的 hash
- ✓ 如果提取到新数据，`updatedCount` 增加

### 3.4 错误重试机制测试

#### 测试点 4.1：网络超时重试
**目的**：验证超时错误会触发重试

**模拟方法**：
- 临时修改 `requestTimeoutMs` 为很小的值（如 1ms）
- 或使用网络代理模拟慢速连接

**步骤**：
1. 在 Sources Tab 中编辑 "最酷体育（Zuicool）"
2. 将 `requestTimeoutMs` 修改为 `1`
3. 保存
4. 触发同步

**预期结果**：
- ✓ 同步状态经历 "running" -> "retrying" -> "retrying" -> "failed"
- ✓ `attempt` 字段递增（1 -> 2 -> 3）
- ✓ 每次重试之间有退避延迟（30s -> 60s -> 90s）
- ✓ 达到 `retryMax` 次数后状态变为 "failed"
- ✓ `errorMessage` 包含超时信息
- ✓ `nextCheckAt` 根据失败策略设置

**恢复**：
1. 将 `requestTimeoutMs` 改回 `15000`
2. 触发新的同步验证恢复正常

#### 测试点 4.2：HTTP 错误处理
**目的**：验证 HTTP 错误（404, 500等）的处理

**模拟方法**：
- 临时将 `sourceUrl` 修改为不存在的 URL

**步骤**：
1. 在 Marathon Sources 中选择一条记录
2. 编辑 `sourceUrl` 为 `https://www.zuicool.com/event/nonexistent-12345`
3. 触发同步

**预期结果**：
- ✓ 同步状态为 "failed" 或显示错误
- ✓ `lastHttpStatus` 记录错误状态码（如 404）
- ✓ `lastError` 包含错误描述
- ✓ 根据重试策略设置 `nextCheckAt`

#### 测试点 4.3：退避策略验证
**目的**：验证指数退避重试间隔

**验证公式**：
```
nextRetryDelay = retryBackoffSeconds * attempt
实际延迟 = max(nextRetryDelay, minIntervalSeconds)
```

**测试数据**：
- `retryBackoffSeconds` = 30
- `minIntervalSeconds` = 21600

**预期退避时间**：
- 第1次失败：30 * 1 = 30秒 < 21600秒，实际使用 21600秒（6小时）
- 第2次失败：30 * 2 = 60秒 < 21600秒，实际使用 21600秒
- 第3次失败：30 * 3 = 90秒 < 21600秒，实际使用 21600秒

**验证方法**：
```sql
-- 查看重试记录的时间间隔
SELECT id, attempt, started_at, finished_at, status, error_message
FROM marathon_sync_runs
WHERE source_id = (SELECT id FROM sources WHERE name = '最酷体育（Zuicool）')
  AND status IN ('retrying', 'failed')
ORDER BY started_at DESC;
```

### 3.5 数据提取准确性测试

#### 测试点 5.1：raceDate 提取
**目的**：验证能够正确提取赛事日期

**检测方法**：
1. 在 needs_review Tab 中查看提取结果
2. 点击某条 raw 记录查看详情

**预期结果**：
- ✓ `metadata.extraction.raceDate` 格式为 `YYYY-MM-DD`
- ✓ 日期在合理范围内（2000-2100年）
- ✓ 提取方法（method）为 "rule"、"jsonld"、"regex" 或 "ai" 之一
- ✓ 如果使用 rule，提取到的值符合配置的 selector

#### 测试点 5.2：registrationStatus 提取
**目的**：验证能够提取报名状态

**预期结果**：
- ✓ `metadata.extraction.registrationStatus` 有值
- ✓ 常见状态包括：报名中、已截止、即将开放等

#### 测试点 5.3：registrationUrl 提取
**目的**：验证能够提取报名链接

**预期结果**：
- ✓ `metadata.extraction.registrationUrl` 是有效的 URL
- ✓ URL 为绝对路径（已解析相对路径）
- ✓ URL 指向报名相关页面

#### 测试点 5.4：AI 兜底提取（可选）
**前提**：设置 `AI_ENABLE_FALLBACK=true` 且配置了 API key

**目的**：验证规则提取失败时 AI 能够兜底

**步骤**：
1. 临时将 extract 规则的 selector 改为无效值
2. 触发同步
3. 查看 needs_review

**预期结果**：
- ✓ `metadata.ai.used` 为 `true`
- ✓ `metadata.extraction.method` 为 "ai"
- ✓ AI 提取到了 `raceDate`
- ✓ `metadata.ai.model` 记录了使用的模型

### 3.6 数据复核与回填测试

#### 测试点 6.1：needs_review 队列
**目的**：验证提取的数据进入复核队列

**步骤**：
1. 打开 `/admin/data` -> needs_review Tab
2. 查看记录列表

**预期结果**：
- ✓ 显示所有 `status=needs_review` 的记录
- ✓ 显示 Marathon 名称、Source 名称
- ✓ 显示抓取时间（fetchedAt）
- ✓ 显示提取方法（method）
- ✓ 每条记录有 "查看详情" 按钮

#### 测试点 6.2：复核详情查看
**目的**：验证能够查看原始内容和提取结果

**步骤**：
1. 点击某条记录的 "查看详情"
2. 查看显示的信息

**预期结果**：
- ✓ 显示完整的 metadata（包括 extraction 字段）
- ✓ 显示 httpStatus、contentHash
- ✓ 显示原始 URL
- ✓ 如果有 rawContent，可以查看（或提供预览）

#### 测试点 6.3：回填到 marathon_editions
**目的**：验证复核通过后能够回填数据

**步骤**：
1. 在详情页点击 "回填到赛事版本" 或 "标记为已处理"
2. 确认操作

**预期结果**：
- ✓ `raw_crawl_data.status` 更新为 "processed"
- ✓ `raw_crawl_data.processedAt` 更新
- ✓ `marathon_editions` 表中对应记录的 `raceDate` 等字段已更新
- ✓ `lastSyncedAt` 更新
- ✓ 该记录从 needs_review 列表中消失

### 3.7 调度器集成测试

#### 测试点 7.1：定时触发
**前提**：设置 `SYNC_SCHEDULER_ENABLED=true`

**目的**：验证调度器能够定时触发同步

**步骤**：
1. 启动应用（`npm run dev`）
2. 观察日志输出
3. 等待 5 分钟（默认间隔）

**预期结果**：
- ✓ 应用启动时看到 "Sync scheduler started" 日志
- ✓ 每 5 分钟触发一次同步检查
- ✓ 只有满足 `nextCheckAt <= now` 的 marathon_sources 被同步
- ✓ 日志中显示同步的 source 名称和结果

#### 测试点 7.2：Advisory Lock 互斥
**目的**：验证多实例运行时不会重复抓取

**步骤**：
1. 在两个终端同时启动应用
2. 两个实例同时触发同步

**预期结果**：
- ✓ 只有一个实例获得锁并执行同步
- ✓ 另一个实例跳过，日志显示 "lock is held by another instance"
- ✓ 没有重复的 sync run 记录

### 3.8 性能与资源测试

#### 测试点 8.1：内存使用
**目的**：验证不会发生内存泄漏

**监控指标**：
- rawContent 最大长度限制（2MB）
- 长时间运行后内存稳定

**验证方法**：
```bash
# 观察进程内存
ps aux | grep node
```

#### 测试点 8.2：并发处理
**目的**：验证能够处理多个 marathon_sources

**步骤**：
1. 绑定 5-10 个不同的赛事到最酷体育 source
2. 触发同步

**预期结果**：
- ✓ 所有 sources 按顺序处理
- ✓ 没有并发冲突
- ✓ 每个 source 的状态独立更新

## 四、边界条件测试

### 4.1 空数据处理
- [ ] HTML 内容为空
- [ ] 选择器未匹配到元素
- [ ] 提取到的值为空字符串

### 4.2 异常数据处理
- [ ] 日期格式不正确
- [ ] URL 为相对路径
- [ ] 包含特殊字符的数据

### 4.3 大数据量处理
- [ ] HTML 超过 2MB（应被截断）
- [ ] 列表页包含大量链接（>100条）

## 五、回归测试清单

在修改配置或代码后，重新运行以下核心测试：

1. **配置验证**
   - [ ] Sources 配置正确
   - [ ] Extract 规则有效

2. **基础功能**
   - [ ] 首次抓取成功
   - [ ] 增量更新工作
   - [ ] 重试机制生效

3. **数据质量**
   - [ ] raceDate 提取准确
   - [ ] URL 解析正确
   - [ ] 无数据丢失

4. **错误处理**
   - [ ] 网络错误恢复
   - [ ] 超时正确处理
   - [ ] 错误日志完整

## 六、已知限制与注意事项

### 6.1 网站变化
- 最酷体育网站可能更新 HTML 结构
- 需要定期检查 selector 是否仍然有效
- 建议每月人工验证一次提取准确性

### 6.2 反爬虫
- 控制抓取频率（当前设置为 6 小时间隔）
- 使用合理的 User-Agent
- 遵守 robots.txt

### 6.3 数据一致性
- 同一赛事可能在多个平台出现
- 需要人工确认和去重
- 优先使用官网数据（priority 更高）

## 七、测试执行记录

### 测试执行信息
- **测试日期**：2026年2月17日
- **测试环境**：开发环境
- **测试人员**：开发团队
- **应用版本**：v0.6 Alpha

### 测试结果汇总
| 测试类别 | 测试点数量 | 通过 | 失败 | 跳过 | 备注 |
|---------|-----------|------|------|------|------|
| 配置验证 | 2 | - | - | - | 待执行 |
| HTML解析 | 2 | - | - | - | 待执行 |
| 增量更新 | 3 | - | - | - | 待执行 |
| 错误重试 | 3 | - | - | - | 待执行 |
| 数据提取 | 4 | - | - | - | 待执行 |
| 数据复核 | 3 | - | - | - | 待执行 |
| 调度器 | 2 | - | - | - | 待执行 |
| 性能测试 | 2 | - | - | - | 待执行 |

### 测试问题记录
（在实际测试中发现的问题将记录在此）

---

## 附录

### A. 相关文档
- [项目计划 - 下一步开发计划](../项目计划/下一步开发计划-2026-02-16.md)
- [项目计划 - 阶段一 1.3 数据采集详细计划](../项目计划/项目计划-阶段一-1.3-数据采集与调度-详细计划.md)
- [使用说明 - 数据采集与管理后台](../使用说明/使用说明-数据采集与管理后台.md)
- [研究报告 - 马拉松数据源调研](../研究报告/研究报告-马拉松数据源调研.md)

### B. 快速测试命令

```bash
# 环境准备
export DATABASE_URL="postgresql://..."
export ADMIN_API_TOKEN="your-token"
npm run db:ensure
npm run config:import

# 启动应用
npm run dev

# 手动触发同步（通过 API）
curl -X POST http://localhost:5000/api/admin/sync/run-all \
  -H "Content-Type: application/json" \
  -H "X-Admin-Token: your-token"

# 查看同步记录
curl http://localhost:5000/api/admin/sync/runs?limit=10 \
  -H "X-Admin-Token: your-token"

# 查看 needs_review 队列
curl "http://localhost:5000/api/admin/raw-crawl?status=needs_review&limit=10" \
  -H "X-Admin-Token: your-token"
```

### C. 数据库查询示例

```sql
-- 查看最酷体育的 source 配置
SELECT id, name, type, strategy, priority, is_active, config
FROM sources
WHERE name = '最酷体育（Zuicool）';

-- 查看绑定的 marathon_sources
SELECT ms.id, m.name as marathon_name, ms.source_url, 
       ms.last_checked_at, ms.next_check_at, ms.last_hash
FROM marathon_sources ms
JOIN marathons m ON m.id = ms.marathon_id
WHERE ms.source_id = (SELECT id FROM sources WHERE name = '最酷体育（Zuicool）');

-- 查看同步历史
SELECT id, status, attempt, new_count, updated_count, unchanged_count,
       started_at, finished_at, error_message
FROM marathon_sync_runs
WHERE source_id = (SELECT id FROM sources WHERE name = '最酷体育（Zuicool）')
ORDER BY started_at DESC
LIMIT 10;

-- 查看提取的数据（needs_review）
SELECT id, status, http_status, 
       metadata->'extraction'->>'method' as method,
       metadata->'extraction'->>'raceDate' as race_date,
       fetched_at
FROM raw_crawl_data
WHERE source_id = (SELECT id FROM sources WHERE name = '最酷体育（Zuicool）')
  AND status = 'needs_review'
ORDER BY fetched_at DESC;
```
