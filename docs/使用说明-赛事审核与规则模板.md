# 使用说明：赛事审核与规则模板（/admin/data）

本文专门回答赛事审核中最常见的 7 个问题：
1. `sources.config` 里的 JSON 到底怎么写、有什么硬性要求
2. 报名状态为什么必须是选项，不建议自由输入
3. `metadata`（只读）和上面回填字段是什么关系
4. AI 规则模板生成器（`sources.config.extract`）的用途，以及 `extract` 为空时如何处理
5. 赛事审核（`needs_review`）的标准操作流程
6. `canonicalName` 的规则、用途和填写建议
7. 国家/地区字段的“两级结构”规则与前台分类逻辑

## 1) 数据中的 JSON 有什么要求

### 1.1 适用范围
- 在 Sources 页编辑的是 `sources.config`（存储在 DB 的 JSONB）。
- 该 JSON 主要用于两类能力：
  - 详情页字段提取：`config.extract`
  - 列表页批量发现：`config.discovery`

### 1.2 基本要求
- 必须是合法 JSON（不能写注释、不能有尾逗号）。
- 顶层必须是对象（`{}`），不是数组。
- 不认识的字段会被忽略，建议只保留系统已用字段，避免后续维护混乱。

### 1.3 `extract` 推荐格式
```json
{
  "extract": {
    "raceDate": {
      "selector": "meta[property='event:start_date']",
      "attr": "content"
    },
    "registrationStatus": {
      "selector": ".status, .signup-status",
      "attr": "text"
    },
    "registrationUrl": {
      "selector": "a[href*='register'], a[href*='signup']",
      "attr": "href"
    }
  }
}
```

字段说明：
- `selector`：CSS 选择器（必填）。
- `attr`：可选，默认按文本读取；常见值：`text`、`html`、`href`、`content`。
- `regex`：可选，二次正则提取。
- `group`：可选，正则分组序号。

### 1.4 `discovery`（列表页发现）格式
```json
{
  "discovery": {
    "list": {
      "itemLink": {
        "selector": "a.event-card, .event-list a[href*='/events/']",
        "attr": "href"
      }
    }
  }
}
```

## 2) 报名状态为什么必须下拉选项

原因：前台展示、筛选、颜色标记依赖固定状态值；自由输入会造成同义词碎片（例如 `open`、`报名中`、`可报名` 混用）。

当前审核界面建议只用三类：
- `报名中`（open）
- `即将开始`（upcoming / not-open）
- `已截止`（closed）

说明：
- 审核弹窗里应从选项选择，不建议手输。
- AI/规则抽取到的英文状态会尝试映射到这三类；映射失败时由人工确认。

## 3) `metadata`（只读）和回填字段的关系

`metadata` 不是最终发布字段本身，而是“过程快照 + 审计日志”。

常见子结构：
- `metadata.extraction`：机器从 raw 中提取到的值、提取方法（rule/json-ld/ai）。
- `metadata.merge`：合并过程和冲突信息（来源优先级比较）。
- `metadata.manualResolve`：你在审核弹窗手工回填时提交的内容和时间。

和上面输入框的关系：
- 输入框是“你这次准备保存到 edition 的目标值”。
- `metadata` 是“系统如何得到候选值、你如何处理它”的记录。
- 两者不是严格一一对应，最终以保存后的 `marathon_editions` 为准。

## 4) AI 规则模板生成器是做什么的，`extract` 为空怎么办

### 4.1 用途
AI 模板生成器会基于当前 raw 的 `rawContent` 自动产出 `sources.config.extract` 规则草稿，不会直接修改 `metadata`。

返回通常包含：
- `template.extract`：可写入 source 配置的规则
- `notes`：模型解释
- `evidence`：证据片段
- `preview`：规则在当前 rawContent 上的试跑结果

### 4.2 `extract` 为空的常见原因
- 该 URL 返回的 HTML 没有赛事字段（常见于前端 SPA，只看到 `<div id="app"></div>`）。
- 你抓到的是列表页/跳转页，不是赛事详情页。
- 页面数据在后续 JS 请求里，首屏 HTML 不含日期/状态/报名链接。

### 4.3 处理步骤（实操）
1. 先确认绑定 URL 是“赛事详情页”而不是列表页。
2. 在 Raw 明细里看 `rawContent` 是否真的包含日期/状态/报名链接文本。
3. 若 `rawContent` 为空壳（如只有 `#app`），优先改用可直接返回内容的详情 URL。
4. 必要时先人工回填并发布，后续再补稳定规则。
5. 生成模板后先看 `preview`，确认命中再“写入到数据源配置”。

## 5) 赛事审核标准流程（needs_review）

1. 进入 `/admin/data`，在 Raw Crawl 里筛选 `needs_review`。
2. 点“复核/回填”，先看原文摘要与 metadata 判断问题类型（缺字段/冲突/异常页面）。
3. 填写：
   - 优先填 `raceDate`（`YYYY-MM-DD`）。
   - 没有完整日期时至少填 `year`。
   - `registrationStatus` 必须选项选择。
   - `registrationUrl` 填可直接访问的报名页或详情页。
4. 需要立刻前台可见则勾选“回填后发布”。
5. 点击“回填并标记 processed”。

保存后的结果：
- 以 `marathonId + year` upsert 到 `marathon_editions`。
- 当前 raw 标记为 `processed`。
- 本次人工动作写入 `metadata.manualResolve` 便于追踪。

## 6) `canonicalName` 规则、要求、用在哪里

### 6.1 它是什么
- `canonicalName` 是赛事的“稳定标识名”（逻辑主键之一），不是给用户看的展示名。
- 展示名用 `name`，`canonicalName` 主要给系统做去重、检索、对齐。

### 6.2 系统要求（硬约束）
- 不能为空。
- 在 `marathons` 表里必须唯一（数据库唯一索引）。

### 6.3 推荐写法（强烈建议）
- 使用稳定、不带年份的名称。
- 推荐小写 + 连字符（kebab-case），例如：
  - `beijing-marathon`
  - `shanghai-half-marathon`
  - `xiamen-marathon`
- 不要把届次或年份写进 `canonicalName`（例如不要 `beijing-marathon-2026`）。

### 6.4 在哪里用到
- 去重/合并：`/api/marathons` 的 upsert 以 `canonicalName` 作为冲突目标。
- 后台搜索：管理接口会按 `name` + `canonicalName` 共同检索赛事。
- 绑定与管理页展示：后台列表中会显示 `canonicalName` 便于核对同名赛事。

### 6.5 在哪里修改
- 在 `/admin/data` 的“赛事资料中心（统一编辑）”里可直接修改。
- 修改后会影响后续检索、去重与后台管理显示；前台展示标题仍以 `name` 为主。

### 6.6 什么时候不建议改
- 已有赛事通常不建议改 `canonicalName`（除非早期填错）。
- 原因：它是系列赛事的稳定标识，改动会影响后台检索、去重判断与跨年份关联理解。
- 建议流程：
  - 新增赛事时一次性规范填写 `canonicalName`
  - 后续新年份（2027、2028...）继续绑定到同一赛事主体，不新建新的 `canonicalName`

## 7) 国家/地区字段的“两级结构”规则

### 7.1 目标结构
- 一级：是否中国
  - `China`
  - `Overseas`（非中国）
- 二级：
  - 若中国：`country` 统一存为 `China`
  - 若非中国：`country` 填具体国家名（如 `Japan`、`USA`、`Germany`）

### 7.2 后台填写规则（赛事资料中心）
- 选择“中国”时，系统会把 `country` 自动按 `China` 保存。
- 选择“非中国（海外）”时，必须填写具体国家。
- 这样做是为了保证前台“国内/海外”分类稳定，不受 `中国/CN/CHN` 等多写法影响。

### 7.3 前台分类规则
- 国内赛事：按 `country=China` 归类（并兼容历史别名映射）。
- 海外赛事：非 `China` 的国家归类为海外。
- 建议后续数据统一按本规则维护，逐步减少历史脏值。
