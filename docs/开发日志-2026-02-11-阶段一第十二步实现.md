# 开发日志 - 2026-02-11 - 阶段一第十二步实现（发布态 Draft/Published）

## 目标
1. 增加赛事历届（`marathon_editions`）的发布态：`draft/published`。
2. 前台默认只展示 `published`（减少未确认/半成品数据对用户的干扰）。
3. 后台在人工复核回填时可选择“回填后发布”，用于把确认过的数据推到前台。

## 设计要点
- 发布态在 `marathon_editions` 层做（同一赛事不同年份可分别发布）。
- 默认策略：
  - 旧数据：按是否有 `race_date` 进行回填（有日期 => published；无日期 => draft）。
  - 定时同步：只有 `official` 数据源的抓取结果会自动发布（并且需要成功抽取到 `raceDate`）。
  - 人工复核：在 needs_review “回填”时可选是否发布。

## 主要改动
### 1) 数据库字段
- `marathon_editions` 新增：
  - `publish_status`（text，not null，default `draft`）
  - `published_at`（timestamptz，可空）
- `npm run db:ensure` 已补齐 “ensure + backfill”：
  - `race_date is null => draft`
  - `race_date not null => published` 并补 `published_at`

### 2) 前台接口过滤
- `GET /api/marathons`、`GET /api/marathons/upcoming`、`GET /api/marathons/:id`
  - 默认只返回 `publish_status = published` 的 editions

### 3) 同步自动发布策略
- `server/syncScheduler.ts`
  - 当 source.type = `official` 且抽取到 `raceDate` 时，写入 editions 时自动设置 `publish_status=published`
  - 非 official 来源默认写 `draft`（后续由管理员确认再发布）

### 4) needs_review 回填时支持“回填后发布”
- `/admin/data` 的 needs_review 回填弹窗新增开关：
  - `回填后发布：是/否`
- `POST /api/admin/raw-crawl/:id/resolve` 增加 `publish` 参数

## 验收与验证
### 自动化检查（已通过）
- `npm run check`
- `npm run build`

### 需要你手工测试的点
1. **DB 迁移**
   - 执行 `npm run db:ensure`
   - 验证 `marathon_editions` 存在 `publish_status/published_at` 两列
2. **前台只看 published**
   - 首页与详情页，应该不再展示 draft editions（例如 2026 placeholder 可能会消失）
3. **后台回填后发布**
   - 打开 `http://127.0.0.1:5000/admin/data`
   - 进入 `needs_review` Tab，挑一条记录点“复核/回填”
   - 保持 `回填后发布：是`，回填 `raceDate` 后提交
   - 返回前台刷新，能看到对应 edition 出现/更新

## 下一步建议
1. 增加“发布队列”页面：集中查看 draft editions，并一键发布/撤销发布（避免只靠 needs_review 回填入口）。
2. 与 “AI 规则模板生成器”联动：从 raw 一键生成规则，验证后写入 source config，再触发一次同步，最后发布。

