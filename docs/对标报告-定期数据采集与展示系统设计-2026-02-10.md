# 对标报告：定期数据采集与展示系统设计（2026-02-10）

## 0. 背景与目标
当前项目已经具备：
- 抓取与调度（sources + scheduler）
- 原始内容留存（raw_crawl_data）
- 规则提取 + AI 兜底（可选）
- needs_review 队列 + 人工回填
- 管理界面 `/admin/data`（管理员自用）

但整体“后台管理逻辑”仍偏“把所有能力堆在一个页面”，不利于长期扩展、团队协作和线上运维。

本报告对标 GitHub 上评价较高、且“定期采集/同步/监控 + 可视化管理”特征明显的项目，梳理常见架构模式，并给出本项目的短板与改进建议（以“更好展示最新信息 + 更好定期更新”为主要目标）。

## 1. 对标项目（形态借鉴）

### A. “页面监控/抓取留痕 + UI 运维”类
- changedetection.io：以“watch + schedule + diff history + notifications + UI 运维”为核心，特别适合你现在的 `raw_crawl_data + hash + runs` 思路扩展到“可视化 diff/告警”。（GitHub 项目）
- Huginn：以“Agent”作为最小单元，Agent 可定时触发、产出 event，再由后续 Agent 处理；UI 中天然区分不同类型任务。（GitHub 项目）

### B. “数据同步/ELT Connector + Run 历史 + 调度”类
- Airbyte：Connector + Connection + Schedule + Sync Runs 的模型非常清晰（“连接器/连接/同步运行/调度”四层）。
- Meltano：强调 pipeline/target 的可组合与可重复运行，通常会有 schedule 与日志追溯。

### C. “工作流编排/数据管道编排（重型但成熟）”类
- Apache Airflow：DAG 为单位，天然把“不同模式更新”拆成不同任务；UI 以 DAG/Run/Log/Retry 为核心。
- Dagster：资产化（Asset）+ UI（Runs / Assets）对“数据更新链路可观测性”很强。
- Prefect：以 Flow 为单位，触发/调度/观测/重跑都在 UI 里是第一公民。
- Kestra / n8n：偏“可视化工作流 + Trigger”，适合“发现/绑定/抓取/抽取/合并/发布”的流程化拆解。

> 选择这些项目的原因：它们都把“定期执行、可观测性、错误隔离、可重跑、配置化”当作产品核心，而不是“写几个 cron 就算完”。

## 2. 通常这种项目怎么设计（前台 + 后台）

### 2.1 数据生命周期（最通用的分层）
建议把数据分成 3 层（对标 changedetection/Airbyte/Airflow 的设计共性）：
1. **Raw（原始层）**：抓到什么就存什么（你已有 raw_crawl_data）
2. **Staging/Extracted（抽取层）**：从 raw 提取结构化字段，带上置信度、证据片段、来源信息
3. **Published（发布层）**：前台真正展示的数据（稳定、可解释、可回滚）

你目前做到了 Raw 和部分 Extracted（通过 metadata + field_sources），但 **缺少“发布态（Published）/草稿态（Draft）”的显式分层**，导致前台与后台耦合。

### 2.2 前台（用户侧）常见设计
核心目标是“更好展示最新信息”：
- **默认只展示未来/近期**：通常从“当月起”的 upcoming 事件开始展示；历史作为二级入口（筛选/年份归档）。
- **未确认数据（TBD）如何处理**：
  - 常见做法 1：默认不进主列表，单独一个“待确认日期”区域（或需要用户勾选“显示待确认”）
  - 常见做法 2：允许显示，但明确标注“待定/未确认”，避免用户误以为是今天/本周
- **变更可感知**：如果用户关心“报名开启/截止变化”，通常会做“状态变化提示/订阅/收藏提醒”（后续可做）

本项目已做了一个改进：
- 列表中新增“打开官网”快捷入口（有 websiteUrl 才显示）
- 对 `raceDate=null` 的赛事在列表末尾归入“待确认日期”，避免污染日期排序

### 2.3 后台（管理员侧）常见设计
高分项目基本都具备：
- **任务分解**：不同模式更新拆成不同 Task/Flow/DAG，并能独立触发（Airflow/Dagster/Prefect/Kestra/n8n 的共同点）
- **调度与单次运行分离**：
  - Schedule 页面：定义周期、并发、频率限制、开关
  - Run 页面：运行历史、日志、重跑、失败原因、输出统计
- **复核队列**：当自动抽取失败/冲突时进入队列，有明确的“处理/忽略/回填”动作（changedetection 的 review/diff + 你的 needs_review 思路）

对本项目而言，建议把后台拆为至少 5 个逻辑页（可以是多页面，也可以是一个页面的 Tab）：
1. Overview：最近运行健康度、失败率、needs_review 数量
2. Sources：数据源目录 + 抽取规则（配置）
3. Scheduler：调度开关、频率限制、并发、错峰
4. Runs & Logs：同步记录、错误聚类、重跑入口
5. Review Queue：needs_review 的处理（回填/忽略/生成规则模板）
6. Discovery & Binding：搜索发现 + 详情页绑定（半自动）

## 3. AI 在这种系统里通常放哪（怎么更“智能”）
常见落点（从“最稳”到“更激进”）：
1. **抽取兜底**：规则提取失败时用 LLM 从 HTML 里抽结构化字段（你已实现可选的 AI 兜底）
2. **规则生成器（推荐下一步）**：让 AI “生成 selector/regex 模板”，再由管理员一键落库并验证
   - 输入：raw HTML + 目标字段 + 示例输出
   - 输出：`sources.config.extract` 的 JSON 模板 + 置信度 + 证据片段（例如在哪个节点找到日期）
   - 好处：把 AI 的不确定性收敛为“可审计的规则”，成本可控，长期可维护
3. **冲突裁决**：当官网与平台冲突时，让 AI 给出“为什么冲突/哪个更可信”的解释（仍建议人工最终确认）
4. **发现/去重**：把 Brave 搜索结果聚类、匹配到已有赛事（名称相似度 + AI 辅助），减少人工绑定成本

## 4. 本项目对标短板（当前最影响“清晰度/长期可维护”的点）
1. **后台 UI 信息密度过高**：`/admin/data` 集中展示太多能力，缺少“工作流分区”和“入口引导”
2. **缺少发布态（Draft/Published）**：前台展示与后台抽取/复核没有清晰边界
3. **任务边界不清**：抓取/抽取/合并/复核/发布本质上是不同任务，后续会越来越难排错与扩展
4. **可观测性还不够产品化**：缺少“错误聚类、源站健康度、字段覆盖率、冲突统计”等面向运营的指标
5. **对用户展示策略仍可优化**：默认应“未来优先 + 历史归档 + TBD 单列”，减少噪音

## 5. 建议的改进路线（可按迭代逐步落地）

### 5.1 结构重构（不改变核心逻辑，只让逻辑更清晰）
- 把 `/admin/data` 改为 Tab 化或多页：
  - Overview / Sources / Schedules / Runs / Review / Discovery
- 把 “单次触发” 与 “定期设置” 拆开：UI 上不同按钮、不同区域、不同 API 命名

### 5.2 发布态（对前台体验提升最大）
- `marathon_editions` 增加 `publishStatus`（draft/published）或 `publishedAt`
- 前台默认只展示 published；TBD/needs_review 只在“待确认/管理员视图”里出现

### 5.3 AI 规则模板生成（最划算的 AI 用法）
- 新增一个 Admin 操作：
  - 从某条 raw 记录一键调用 AI 输出 `sources.config.extract` 模板
  - 管理员审核后保存到 source config
  - 立即触发该 source 的单次同步验证

### 5.4 逐步平台化（最酷/爱燃烧）
- 先保持“发现 -> 绑定 -> 抓取详情页”的半自动路线（已做 discovery + bind）
- 后续再做平台结构化抽取（列表页发现 + 详情页字段映射）

## 6. 附录：本项目当前已具备的“对标能力清单”
- 运行记录：`marathon_sync_runs`
- 抓取留痕：`raw_crawl_data`（含 status/metadata）
- 人工复核：needs_review + resolve/ignore
- 字段级合并：`marathon_editions.field_sources`（官网 > 平台 > 搜索）
- YAML 配置：`config/sources.yaml` + `npm run config:import`

## 7. 参考链接（对标项目）
- changedetection.io: https://github.com/dgtlmoon/changedetection.io
- Huginn: https://github.com/huginn/huginn
- Apache Airflow: https://github.com/apache/airflow
- Dagster: https://github.com/dagster-io/dagster
- Prefect: https://github.com/PrefectHQ/prefect
- Meltano: https://github.com/meltano/meltano
- n8n: https://github.com/n8n-io/n8n
- Kestra: https://github.com/kestra-io/kestra
- Airbyte: https://github.com/airbytehq/airbyte
