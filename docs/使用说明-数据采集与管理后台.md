# 使用说明：数据采集与管理后台（Stage 1.3）

本说明覆盖：
1. 如何使用 `/admin/data` 做数据源配置、触发同步、查看 raw 队列
2. `sources.config` 的 JSON 填写方式（尤其是 `extract`）
3. 如何处理 `needs_review`（复核/回填字段）
4. 数据源优先级与冲突处理逻辑（官网 > 平台 > 搜索）

## 1) 前置配置（.env）

最少需要：
- `DATABASE_URL=...`
- `ADMIN_API_TOKEN=...`（管理端 token；未配置则 `/api/admin/*` 返回 404）

可选（按需）：
- 调度器（开发环境默认关闭）：`SYNC_SCHEDULER_ENABLED=true`
- AI 兜底（默认关闭）：`AI_API_KEY`、`AI_MODEL`、`AI_ENABLE_FALLBACK=true`
- Discovery 搜索：`BRAVE_API_KEY`

## 2) 管理界面入口

打开：
```text
http://127.0.0.1:5000/admin/data
```

使用方式：
1. 在页面顶部输入 `ADMIN_API_TOKEN`（会保存到本机 `localStorage`）
2. 概览：查看 sources/raw/runs 的统计与近 24h 指标，并可“立即同步一次”
3. Sources：查看/启用/调整 priority/编辑 config(JSON)
4. 同步：查看最近运行记录，点击“立即同步一次”触发单次同步
5. 绑定/发现：用 Brave 搜索找到候选页面，再做绑定（Bind Marathon Source），并检查 Marathon Sources 绑定列表
6. needs_review：查看 raw 队列（默认 `needs_review`），点击“复核/回填”进入处理流程
7. 定期更新：查看调度器相关环境变量说明（当前版本以 env 配置为准）

## 3) Sources 配置：JSON 怎么填

`sources.config` 存在 DB 的 `sources.config`（JSONB）。当前 HTML 抽取规则入口为：
```json
{
  "extract": {
    "raceDate": {
      "selector": "CSS_SELECTOR",
      "attr": "text|html|href|content|...",
      "regex": "REGEX_STRING",
      "group": 1
    },
    "registrationStatus": {
      "selector": "...",
      "attr": "text"
    },
    "registrationUrl": {
      "selector": "...",
      "attr": "href"
    }
  }
}
```

字段解释：
- `selector`：CSS 选择器（取第一个匹配元素）
- `attr`：
  - `text`：取元素文本（默认）
  - `html`：取元素 innerHTML
  - 其他：按属性名取值（例如 `href`、`content`）
- `regex`：可选，对取到的值再做一次正则提取（字符串形式）
- `group`：可选，正则分组编号（默认 1）

常用示例：
1. 从 `<meta>` 里取日期：
```json
{
  "extract": {
    "raceDate": {
      "selector": "meta[property='event:start_date']",
      "attr": "content"
    }
  }
}
```

2. 从页面文字里用正则抽取英文日期：
```json
{
  "extract": {
    "raceDate": {
      "selector": "body",
      "attr": "text",
      "regex": "((January|February|March|April|May|June|July|August|September|October|November|December)\\\\s+\\\\d{1,2},\\\\s+20\\\\d{2})",
      "group": 1
    }
  }
}
```

3. 抽取报名链接：
```json
{
  "extract": {
    "registrationUrl": {
      "selector": "a[href*='register'], a[href*='signup'], a[href*='entry']",
      "attr": "href"
    }
  }
}
```

提示：
- 抽取到的 `registrationUrl` 会按页面 URL 做相对路径解析为绝对 URL（能解析时）。
- 规则提取失败时会尝试 JSON-LD Event（`startDate`），再失败可按需启用 AI 兜底。

## 4) needs_review：怎么处理与回填

`raw_crawl_data.status` 可能出现：
- `processed`：成功提取并写回（或没有冲突）
- `needs_review`：没有提取到 `raceDate` 或出现低优先级冲突，需要人工确认
- `ignored`：管理员忽略

处理步骤：
1. 在 `/admin/data` 的 Raw Crawl 里筛选 `needs_review`
2. 点“复核/回填”
3. 填写：
   - 有 `raceDate` 就填 `YYYY-MM-DD`（会自动得到 year）
   - 没有 `raceDate` 但要回填报名信息时，必须填写 `year`
   - `registrationStatus` / `registrationUrl` 选填
   - `回填后发布`：开启则发布到前台；关闭则保持 draft（前台不可见）
4. 点击“回填并标记 processed”

回填后：
- 会写入 `marathon_editions`（按 `marathonId + year` upsert）
- 会把该条 raw 标记为 `processed`，并在 `metadata.manualResolve` 记录本次人工处理内容

## 5) 合并与冲突：官网 > 平台 > 搜索

系统对 `raceDate/registrationStatus/registrationUrl` 做字段级合并：
- 每个字段会记录来源（`marathon_editions.field_sources`）
- 新数据写入时会比较来源优先级：
  - `official` > `platform` > `search`（同类型再比较 `priority`）
- 当低优先级来源与高优先级字段冲突（值不同）：
  - 不覆盖高优先级字段
  - raw 记录会标记为 `needs_review`（方便人工确认）

## 6) YAML 配置导入（首次安装/版本控制）

仓库内置：
- `config/sources.yaml`

导入到 DB：
```powershell
npm run config:import
```

说明：
- YAML 用于“版本控制/首次安装”的配置基线
- 运行时以 DB 为准（可以在 `/admin/data` 里直接编辑 `sources.config`）

## 7) 导入你整理的官网清单（docs/marathon list.txt）

如果你把赛事官网整理在 `docs/marathon list.txt`（Markdown 表格），可以直接导入到数据库（会 upsert `marathons.websiteUrl` 并自动绑定到 “赛事官方网站（直采）”）：
```powershell
npm run marathons:import-list
```

说明：
- 会为每个赛事补一条 2026 年的占位 edition（`raceDate` 为空，方便在前端列表稳定展示）
- 可在 `/admin/data` 的 Bind/Raw 流程继续做详情页绑定与复核回填
