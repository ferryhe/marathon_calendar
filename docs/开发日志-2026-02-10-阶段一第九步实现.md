# 开发日志 - 2026-02-10 - 阶段一第九步实现（1.3：needs_review 复核回填 + 合并策略 + 平台绑定）

## 目标
1. 为 `needs_review` 增加“标记已复核/回填字段”的管理接口与 UI（避免只看不改）。
2. 实现字段级合并策略与冲突处理（官网 > 平台 > 搜索）。
3. 平台源先做“发现 + 详情页绑定”的半自动流程（管理员自用），后续再做定时抓取适配。
4. 补充文档：说明如何使用管理界面与 JSON 配置。

## 主要改动

### 1) 字段级合并与冲突处理
- 新增：`server/editionMerge.ts`
  - `marathon_editions.field_sources` 记录字段来源与 rank
  - 合并优先级：`official > platform > search`（同类再比较 `priority`）
  - 低优先级冲突不覆盖高优先级字段，写入 raw 的 `metadata.merge.conflicts` 并标记 `needs_review`
- 更新：`shared/schema.ts` 新增 `marathon_editions.field_sources`
- 更新：`script/db-ensure-stage1-3-schema.ts` 补齐 `field_sources` 列
- 更新：`server/syncScheduler.ts` 写回 editions 时使用 merge，而不是无脑覆盖

### 2) needs_review 复核回填（Admin API + UI）
- 新增管理接口：
  - `GET /api/admin/raw-crawl?status=...` 支持 status 过滤，返回 `processedAt/metadata`
  - `GET /api/admin/raw-crawl/:id?full=true|false` 查看 raw 明细（默认截断）
  - `POST /api/admin/raw-crawl/:id/resolve` 人工回填到 `marathon_editions` 并标记 raw 为 `processed`
  - `POST /api/admin/raw-crawl/:id/ignore` 忽略该条 raw
- 更新管理界面：`/admin/data`
  - Raw Crawl 默认筛选 `needs_review`
  - 支持“复核/回填”弹窗（带 metadata/rawContent 摘要）

### 3) 平台发现 + 详情页绑定（半自动）
- 新增管理接口：
  - `GET /api/admin/marathons?search=...`（用于绑定前选赛事）
  - `POST /api/admin/marathon-sources`（绑定 marathon + source + URL）
- 更新管理界面：`/admin/data`
  - Discovery 结果支持“一键填充绑定 URL”
  - 新增 Bind Marathon Source 区域：选 Marathon + Source + URL 完成绑定

### 4) 配置与说明文档
- 更新：`config/sources.yaml` 补充数据源调研报告中的官网示例与报名平台（默认不启用，按需开启）
- 新增：`docs/使用说明-数据采集与管理后台.md`（如何使用 + JSON 示例）
- 更新：`docs/研究报告-马拉松数据源调研.md` 增加“在本项目中的落地映射”

## 验收与验证
### 自动化检查（已通过）
- `npm run check`
- `npm run build`

### 冒烟脚本（建议你本机跑一次）
```powershell
npm run db:ensure
tsx script/smoke-stage1-3-sync.ts
```

### 需要你手工验证的点（本地开发环境）
1. 进入管理界面并输入 token：
   ```text
   http://127.0.0.1:5000/admin/data
   ```
2. Raw Crawl：
   - status 过滤填 `needs_review`
   - 打开一条记录点“复核/回填”，填 raceDate 或 year，保存后该条变 `processed`
3. 合并策略：
   - 随便绑定一个平台链接（Bind Marathon Source）
   - 平台提取出的字段若与官网已有字段冲突，应该不会覆盖官网字段，并进入 `needs_review`

## 下一步建议
1. 平台（最酷体育/爱燃烧）做最小可用抓取适配：先跑通“赛事列表发现 + 详情页绑定 + 详情页抽取”。
2. 扩展 `sources.config` 支持按 hostname 的站点特化规则（避免为每个站点建一个 source）。
3. 增加“把 needs_review 的冲突项一键转成 selector 规则”的辅助能力（提高迭代效率）。

