# 马拉松数据提取与处理方案

## 1. 数据提取挑战

在获取到原始网页或API响应后，需要从中提取出结构化的马拉松赛事信息。主要挑战包括：

- **网页结构多样性**：不同网站的HTML结构差异大
- **动态内容加载**：部分网站使用JavaScript动态加载数据
- **反爬虫措施**：验证码、频率限制、User-Agent检测
- **数据格式不统一**：日期、地点等信息格式各异
- **信息完整性**：同一数据源不同时期提供的信息字段可能不同

## 2. 数据提取技术方案

### 2.1 传统网页解析

#### 技术栈
- **Cheerio**：轻量级jQuery选择器，适合静态HTML
- **JSDOM**：完整的DOM实现，适合需要运行JavaScript的场景
- **正则表达式**：提取特定格式的数据

#### 优势
- 速度快，资源消耗少
- 实现简单，成本低
- 适合结构稳定的网站

#### 劣势
- 难以处理复杂的动态网站
- 网站结构变化时需要更新规则
- 需要为每个网站编写特定规则

#### 应用场景
- 简单静态网站
- 结构清晰的列表页面
- API响应数据解析

### 2.2 无头浏览器方案

#### 技术栈
- **Puppeteer**：基于Chrome的无头浏览器
- **Playwright**：支持多浏览器的自动化工具

#### 优势
- 可以处理JavaScript渲染的页面
- 能够模拟用户行为（点击、滚动等）
- 支持截图和PDF生成（用于存档）

#### 劣势
- 资源消耗大
- 速度相对较慢
- 需要更多的服务器资源

#### 应用场景
- 动态加载内容的网站
- 需要登录或交互的页面
- 复杂的单页应用（SPA）

### 2.3 AI辅助提取（推荐方案）

#### 2.3.1 使用场景

AI技术特别适合以下场景：

1. **非结构化文本处理**
   - 从新闻稿、公告中提取赛事信息
   - 处理格式不统一的网页内容
   - 理解自然语言描述

2. **智能字段识别**
   - 自动识别日期、地点、价格等字段
   - 理解上下文（如"报名时间"vs"比赛时间"）
   - 处理中英文混合内容

3. **数据验证与修正**
   - 检查数据逻辑合理性
   - 自动修正常见错误
   - 标准化数据格式

#### 2.3.2 AI API选择

**方案一：大语言模型API**

1. **OpenAI GPT-4/GPT-3.5**
   - 优势：理解能力强，支持中文，可定制提示词
   - 劣势：成本较高，响应时间较长
   - 适用：复杂文本理解，需要推理的场景

2. **阿里云通义千问**
   - 优势：国内服务稳定，中文优化好，价格适中
   - 劣势：能力相对OpenAI略弱
   - 适用：中文内容处理，成本敏感项目

3. **百度文心一言**
   - 优势：国内服务，响应快，价格友好
   - 劣势：能力和稳定性有待提升
   - 适用：简单文本提取，预算有限场景

4. **智谱AI（ChatGLM）**
   - 优势：开源模型可选，性价比高
   - 劣势：需要自己部署（如选择开源版本）
   - 适用：有技术能力的团队

**方案二：专用信息抽取服务**

1. **自然语言处理（NLP）工具**
   - 阿里云NLP
   - 腾讯云NLP
   - 百度NLP

2. **特点**
   - 专注于实体识别、关系提取
   - 价格相对便宜
   - 针对特定任务优化

#### 2.3.3 AI提取工作流程

```
1. 获取网页原始内容
   ↓
2. 预处理（清除广告、导航等无关内容）
   ↓
3. 构建提示词（Prompt Engineering）
   ↓
4. 调用AI API进行信息提取
   ↓
5. 结构化输出（JSON格式）
   ↓
6. 后处理与验证
   ↓
7. 存入数据库
```

#### 2.3.4 提示词设计示例

```
任务：从以下网页内容中提取马拉松赛事信息

网页内容：
[插入网页文本]

请提取以下信息并以JSON格式返回：
{
  "name": "赛事全称",
  "canonicalName": "标准化名称（如'北京马拉松'）",
  "city": "举办城市",
  "country": "国家（如为中国可省略）",
  "raceDate": "比赛日期（YYYY-MM-DD）",
  "registrationOpenDate": "报名开始日期（YYYY-MM-DD）",
  "registrationCloseDate": "报名截止日期（YYYY-MM-DD）",
  "registrationUrl": "报名网址",
  "registrationStatus": "报名状态（open/closed/sold-out/unknown）",
  "websiteUrl": "官方网站",
  "description": "赛事简介（100字以内）",
  "distance": "比赛距离（如'全程马拉松'、'半程马拉松'）",
  "fee": "报名费用"
}

注意事项：
1. 如果某个字段无法确定，返回null
2. 日期必须是YYYY-MM-DD格式
3. canonicalName统一格式为"城市+马拉松"
4. 如有多个比赛项目，只提取全程马拉松信息
```

### 2.4 混合方案（最佳实践）

#### 策略

1. **第一步：常规解析**
   - 对于已知结构的网站，使用预定义的选择器规则
   - 速度快，成本低
   - 适用于90%的常规采集

2. **第二步：AI兜底**
   - 当常规解析失败或置信度低时
   - 使用AI进行智能提取
   - 处理特殊情况和新网站

3. **第三步：人工审核**
   - AI提取后置信度仍然低的数据
   - 新增的赛事信息
   - 用户举报的错误信息

#### 优势
- 兼顾效率和准确性
- 成本可控
- 系统健壮性强

## 3. 数据清洗与标准化

### 3.1 日期处理

**输入格式多样性：**
- "2026年3月15日"
- "2026-03-15"
- "3月15日"
- "2026.3.15"
- "March 15, 2026"

**标准化方案：**
```javascript
// 使用date-fns或day.js进行日期解析
// 统一存储为ISO 8601格式：YYYY-MM-DD
function standardizeDate(dateStr) {
  // 1. 尝试多种格式解析
  // 2. 如果只有月日，添加当前年份或下一年
  // 3. 返回标准格式
}
```

### 3.2 地点标准化

**输入形式：**
- "北京市"、"北京"
- "上海市浦东新区"
- "厦门市思明区"
- "Xiamen, China"

**标准化方案：**
```javascript
// 建立城市代码映射表
const cityMapping = {
  "北京市": { code: "110000", city: "北京", province: "北京" },
  "上海市": { code: "310000", city: "上海", province: "上海" },
  // ...
};

// 提取市级信息，统一格式
function standardizeLocation(location) {
  // 使用正则或NLP提取城市名
  // 映射到标准代码
  // 返回{ city, province, country }
}
```

### 3.3 赛事名称标准化

**canonicalName生成规则：**
- 格式：城市 + 马拉松
- 示例：
  - "2026北京马拉松" → "北京马拉松"
  - "上海国际马拉松赛" → "上海马拉松"
  - "厦门马拉松赛" → "厦门马拉松"

**去重依据：**
- 优先使用canonicalName + year
- 辅助判断：city + date

### 3.4 报名状态标准化

**状态枚举：**
```typescript
enum RegistrationStatus {
  UNKNOWN = 'unknown',      // 未知
  NOT_OPEN = 'not-open',    // 未开放
  OPEN = 'open',            // 报名中
  CLOSED = 'closed',        // 已截止
  SOLD_OUT = 'sold-out',    // 已报满
  CANCELLED = 'cancelled'   // 已取消
}
```

**状态判断逻辑：**
```javascript
function determineStatus(event) {
  const now = new Date();
  
  if (event.registrationOpenDate && now < event.registrationOpenDate) {
    return 'not-open';
  }
  
  if (event.registrationCloseDate && now > event.registrationCloseDate) {
    return 'closed';
  }
  
  if (event.metadata?.isSoldOut) {
    return 'sold-out';
  }
  
  if (event.registrationOpenDate && now >= event.registrationOpenDate) {
    return 'open';
  }
  
  return 'unknown';
}
```

## 4. 数据存储架构

### 4.1 原始数据存储

**目的：**保留原始数据用于审计和重新处理

**方案：**
```javascript
// raw_data表
{
  id: uuid,
  sourceId: string,
  sourceUrl: string,
  rawContent: text,        // 原始HTML或JSON
  contentHash: string,     // 用于检测变化
  fetchedAt: timestamp,
  status: 'pending' | 'processed' | 'failed'
}
```

### 4.2 结构化数据存储

参考现有schema：
- `marathons` - 马拉松基本信息
- `marathon_editions` - 年度赛事信息
- `marathon_sources` - 数据来源关系
- `marathon_sync_runs` - 同步记录

### 4.3 缓存策略

**Redis缓存：**
- 热门赛事信息（TTL: 1小时）
- 最近更新的赛事列表（TTL: 30分钟）
- API响应缓存（TTL: 可配置）

## 5. AI API成本优化

### 5.1 成本控制策略

1. **分级处理**
   - 简单页面：使用传统解析（免费）
   - 复杂页面：使用小模型（GPT-3.5-turbo，成本低）
   - 疑难页面：使用大模型（GPT-4，成本高但准确）

2. **批量处理**
   - 合并多个小任务减少API调用次数
   - 使用异步处理，在低峰期进行

3. **缓存复用**
   - 相同网页结构的多个页面共用解析规则
   - 已提取的数据缓存结果

4. **选择合适的模型**
   - 中文内容优先选择国内模型（价格更低）
   - 简单任务使用小模型
   - 考虑开源模型自部署（长期看成本更低）

### 5.2 成本估算

假设：
- 每个网页平均需要处理的token数：2000
- GPT-3.5-turbo价格：$0.002/1K tokens
- 每日需要处理：100个页面

**月成本：**
- 100页面/天 × 2000 tokens × $0.002/1K × 30天 = $12/月

**使用国内模型（通义千问）：**
- 价格约为OpenAI的1/3-1/2
- 月成本约 ¥30-60

### 5.3 开源模型自部署方案

**推荐模型：**
- **Qwen（通义千问开源版）**
- **ChatGLM3**
- **Llama 3**

**部署方案：**
1. 使用云服务器（GPU实例）
2. 使用Docker容器化部署
3. 结合FastAPI提供API接口
4. 实现请求队列和负载均衡

**成本对比：**
- GPU云服务器：¥300-800/月（根据配置）
- 适合日处理量 > 1000次的场景
- 长期使用成本更低

## 6. 实施建议

### 6.1 第一阶段（MVP）

1. **选择5-10个核心网站**
   - 编写针对性的解析规则
   - 使用Cheerio + Puppeteer

2. **引入AI辅助**
   - 使用通义千问API
   - 仅在解析失败时调用
   - 设置每日调用上限控制成本

3. **人工审核**
   - 所有AI提取的数据人工复核
   - 建立反馈机制优化提示词

### 6.2 第二阶段（扩展）

1. **扩展到30-50个网站**
2. **优化AI提示词和规则**
3. **降低人工审核比例**
4. **实现自动化监控和告警**

### 6.3 第三阶段（成熟）

1. **覆盖100+网站**
2. **AI自动处理占比80%+**
3. **人工审核仅处理异常情况**
4. **考虑自部署开源模型**

## 7. 技术栈推荐

```json
{
  "爬虫框架": "Puppeteer / Playwright",
  "HTML解析": "Cheerio",
  "AI服务": "阿里云通义千问 / OpenAI GPT-3.5",
  "任务队列": "Bull (Redis based)",
  "数据库": "PostgreSQL (现有)",
  "缓存": "Redis",
  "调度": "node-cron",
  "日期处理": "date-fns",
  "日志": "Winston"
}
```

## 8. 结论

建议采用**混合方案**：

1. **核心策略**：传统解析为主，AI辅助为辅
2. **AI选择**：优先使用国内模型（通义千问），成本可控
3. **成本优化**：分级处理 + 缓存复用 + 批量处理
4. **质量保障**：AI提取 + 规则验证 + 人工抽查

这种方案既能保证数据质量，又能控制运营成本，同时具备良好的扩展性。初期AI使用成本约**¥30-60/月**，随着规则库的完善，AI调用比例会逐步降低。
