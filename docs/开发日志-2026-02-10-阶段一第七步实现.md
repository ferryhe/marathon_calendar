# 开发日志 - 2026-02-10 - 阶段一第七步实现（1.3 数据采集系统：爬虫 + 调度）

## 目标
把 1.3 “数据采集系统（爬虫 + 调度）”从占位实现推进到可运行的最小闭环：
- 管理员专用的同步管理接口
- 数据源/绑定/同步记录/原始抓取数据落库
- 后台定时调度（生产默认启用，开发默认关闭）
- 增量更新（内容 hash）+ 重试 + 可观测（sync runs）

## 管理员权限评估
第一版采用 **token 保护的管理接口**，不强制引入用户角色（isAdmin/role）：
- 优点：实现简单、风险面小、不影响普通用户功能
- 缺点：未来若要做管理后台 UI，需要再升级为角色/权限体系

本次落地：`ADMIN_API_TOKEN` + `x-admin-token` header。

## 设计概要
### 数据模型
基于现有表扩展并新增：
- `sources`：补齐 `type/strategy/isActive/retry*/interval/config/lastRunAt/updatedAt`
- `marathon_sources`：补齐 `lastHash/lastHttpStatus/lastError/nextCheckAt`
- `marathon_sync_runs`：补齐 attempt/计数/消息/策略
- `raw_crawl_data`：新增表，用于保存原始抓取结果（含 hash）

### 同步管线（简化版）
1. Scheduler tick
2. 拿 PG advisory lock（多实例互斥）
3. 遍历启用 sources -> 遍历对应 `marathon_sources`（due 才跑）
4. fetch（timeout + UA）
5. content hash：未变化则记为 unchanged；有变化写入 `raw_crawl_data`
6. 提取：优先 JSON-LD Event（`application/ld+json`）提取 `startDate` 作为 `raceDate`
7. 合并：upsert `marathon_editions (marathonId, year)`
8. 更新 `marathon_sources` 的 last* 字段与 nextCheckAt
9. 记录 `marathon_sync_runs`

### 管理接口（管理员专用）
新增：
- `GET /api/admin/sources`
- `PUT /api/admin/sources/:id`
- `POST /api/admin/sync/run-all`
- `POST /api/admin/sync/run-marathon-source`
- `GET /api/admin/sync/runs`
- `GET /api/admin/raw-crawl`

## 实现清单
- schema 更新：`shared/schema.ts`
- DB 对齐脚本：`script/db-ensure-stage1-3-schema.ts`（非交互、幂等）
- 同步器：`server/syncScheduler.ts`
  - `syncMarathonSourceOnce` 可被管理接口调用
  - `syncNowOnce` 带 advisory lock 的单次运行
- 启动行为：`server/index.ts`
  - 生产默认启用同步器
  - 开发默认关闭，需 `SYNC_SCHEDULER_ENABLED=true`
- 管理接口：`server/routes.ts`
- 冒烟验证脚本：`script/smoke-stage1-3-sync.ts`
  - 启动本地 HTTP server（返回带 JSON-LD Event 的 HTML）
  - 插入测试 marathon/source/marathon_source
  - 调用 `syncMarathonSourceOnce`
  - 校验 `marathon_editions` 与 `raw_crawl_data`

## 验收与验证
1. 构建通过：`npm run build`
2. 冒烟脚本通过：`npx tsx script/smoke-stage1-3-sync.ts`

## 文档与配置
- `.env.example` 增加：
  - `ADMIN_API_TOKEN`
  - `SYNC_SCHEDULER_ENABLED`
  - `SYNC_SCHEDULER_INTERVAL_MS`
- 详细计划：`docs/项目计划-阶段一-1.3-数据采集与调度-详细计划.md`

## 下一步建议
1. 增加“配置化提取规则”（CSS selector/regex），让每个官网可无需改代码就能抽取 raceDate/报名状态/报名链接。
2. 做 5-10 个官网的真实验证与适配（按 seed 的官方站点优先级推进）。
3. 引入平台采集（Zuicool/爱燃烧）：先做“赛事列表发现 + 详情页绑定”的半自动流程。
4. 增加字段级增量合并策略与冲突解决（官网优先级 > 平台 > 搜索）。

