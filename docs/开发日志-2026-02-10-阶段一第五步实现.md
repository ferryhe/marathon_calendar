# 开发日志 - 2026-02-10
## 阶段一第五步：收藏的赛事（用户系统）

### 一、开发目标
按路线图继续推进 `1.1.4 用户系统（简化版）` 下一项：

1. 实现“收藏的赛事”完整闭环（后端 + 前端 + 页面入口）。
2. 支持在赛事弹窗与详情页收藏/取消收藏。
3. 完成数据库变更、构建验证和接口链路冒烟测试。

---

### 二、分步实现
#### 2.1 步骤一：数据库与后端收藏 API

对应提交：
- `165707c`

实现内容：
1. 新增收藏表：`user_favorite_marathons`
   - 字段：`id`、`userId`、`marathonId`、`createdAt`
   - 约束：`(userId, marathonId)` 唯一索引，防重复收藏
2. 新增 API：
   - `GET /api/users/me/favorites` 获取我的收藏列表
   - `POST /api/users/me/favorites/:marathonId` 添加收藏
   - `DELETE /api/users/me/favorites/:marathonId` 取消收藏
   - `GET /api/marathons/:marathonId/favorite-status` 获取当前用户收藏状态
3. 收藏列表接口返回赛事摘要信息（名称、地点、官网、简介），前端可直接渲染。

关键文件：
- `shared/schema.ts`
- `server/routes.ts`

---

#### 2.2 步骤二：前端收藏页、路由与数据 hooks

对应提交：
- `dd0148a`

实现内容：
1. 新增收藏相关 API 类型与客户端方法：
   - `getMyFavorites`
   - `addFavorite`
   - `removeFavorite`
   - `getFavoriteStatus`
2. 新增 hooks：
   - `useMyFavorites`
   - `useFavoriteStatus`
   - `useAddFavorite`
   - `useRemoveFavorite`
3. 新增“我的收藏”独立页面：`/my-favorites`
   - 未登录显示登录/注册面板
   - 已登录显示收藏列表，支持跳转详情与取消收藏
4. 首页加入“我的收藏”入口，并接入路由。

关键文件：
- `client/src/lib/apiClient.ts`
- `client/src/hooks/useAuth.ts`
- `client/src/pages/MyFavorites.tsx`
- `client/src/pages/Home.tsx`
- `client/src/App.tsx`

---

#### 2.3 步骤三：收藏交互接入赛事弹窗与详情页

对应提交：
- `a5cac6f`

实现内容：
1. 赛事弹窗接入收藏按钮（支持收藏/取消收藏）。
2. 赛事详情页接入收藏按钮（支持收藏/取消收藏）。
3. 收藏按钮状态联动接口 `favorite-status`。

关键文件：
- `client/src/components/EventDetails.tsx`
- `client/src/pages/MarathonDetail.tsx`

---

### 三、测试与验证
#### 3.1 数据库变更应用
执行：
```bash
npm run db:push
```

结果：
- 新表创建成功，变更已应用。

#### 3.2 构建验证
执行：
```bash
npm run build
```

结果：
- 前后端构建通过。

#### 3.3 收藏接口链路冒烟
临时端口：`5105`

验证步骤：
1. 注册临时用户
2. 获取赛事 ID
3. 添加收藏
4. 查询收藏状态（应为 true）
5. 查询我的收藏列表（应含赛事摘要）
6. 取消收藏
7. 查询收藏状态（应为 false）

结果：
- 输出：`FAVORITE_SMOKE_OK user=phase5_34827 marathon=2026东京马拉松`

---

### 四、验收结论
完成项：
1. [x] 收藏表与唯一约束
2. [x] 收藏 API（增删查 + 状态）
3. [x] 我的收藏独立页面
4. [x] 首页入口与路由
5. [x] 赛事弹窗/详情页收藏交互
6. [x] 数据库、构建、接口冒烟验证通过

剩余项（用户系统）：
1. [ ] 修改个人信息

---

### 五、提交记录
1. `165707c` - `feat(api): add favorites table and endpoints for phase1 step5`
2. `dd0148a` - `feat(web): add my favorites page, routes, and favorite hooks for phase1 step5`
3. `a5cac6f` - `feat(web): enable favorite toggle in modal and detail page for phase1 step5`

---

### 六、下一步建议
1. 推进“修改个人信息”（用户系统最后一项），补齐 `PUT /api/users/me` 与前端设置页。
2. 完成后可切到 `1.1.2` 的“相关赛事推荐”或“分享功能”。 
