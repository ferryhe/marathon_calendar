# 开发日志 - 2026-02-10
## 阶段一第六步：修改个人信息（含微信绑定预留 + 评论头像）

### 一、开发目标
按阶段一 `1.1.4 用户系统（简化版）` 最后一项推进：

1. 支持用户修改个人资料（头像、姓名）。
2. 兼容未来微信接入：预留微信绑定字段和绑定流程。
3. 评论区展示作者头像（有头像则显示，无头像不显示）。

---

### 二、设计说明
#### 2.1 个人资料字段
用户资料新增：
1. `displayName`：姓名，默认等于账号名，可修改。
2. `avatarUrl`：头像地址。
3. `avatarSource`：头像来源（`manual` / `upload` / `wechat`）。

#### 2.2 微信绑定设计（面向未来）
按后续小程序/公众号接入的常见做法，微信绑定应是后端主导：
1. 后端通过 OAuth/code 换取 `openid/unionid`。
2. 后端写入用户表并维护绑定状态。
3. 前端只展示绑定状态并触发授权流程。

本步先落数据结构和接口能力：
1. `wechatOpenId`
2. `wechatUnionId`
3. `wechatNickname`
4. `wechatAvatarUrl`
5. `isWechatBound`
6. `wechatBoundAt`

同时提供开发联调用绑定接口（便于本地模拟）。

#### 2.3 评论头像展示策略
参考常见社区/GitHub风格：
1. 评论列表左侧显示小头像（圆形）。
2. 若无头像则不渲染头像元素，不使用强制占位图。
3. 展示名称优先使用 `displayName`，回退历史 `userDisplayName`。

---

### 三、分步实现
#### 3.1 后端与数据库
对应提交：
- `7d1295f`

实现内容：
1. `users` 表扩展个人资料与微信字段。
2. 新增头像静态目录映射：`/uploads`。
3. 新增接口：
   - `PUT /api/users/me` 更新姓名/头像
   - `POST /api/users/me/avatar/upload` 上传头像（base64图片，落地到 `/uploads/avatars`）
   - `POST /api/users/me/wechat/bind` 开发联调绑定
   - `POST /api/users/me/wechat/unbind` 解绑
4. 评论查询接口联表用户信息，返回 `userAvatarUrl`，并使用 `displayName` 优先展示。
5. 发评论时作者名改为优先使用用户 `displayName`。

关键文件：
- `shared/schema.ts`
- `server/index.ts`
- `server/routes.ts`

#### 3.2 前端页面与交互
对应提交：
- `46c3973`

实现内容：
1. 新增个人资料页：`/profile`。
2. 首页增加“个人资料”入口。
3. 资料页支持：
   - 姓名修改
   - 头像 URL 修改
   - 本地图片上传头像
   - 微信绑定状态展示
   - 开发态模拟微信绑定/解绑
   - 已绑定时“一键使用微信头像”
4. 详情页评论列表增加头像小图标展示（有图才显示）。
5. 前端 API 与 auth hooks 完成新接口封装。

关键文件：
- `client/src/pages/Profile.tsx`
- `client/src/pages/Home.tsx`
- `client/src/pages/MarathonDetail.tsx`
- `client/src/lib/apiClient.ts`
- `client/src/hooks/useAuth.ts`
- `client/src/App.tsx`

---

### 四、测试与验证
#### 4.1 构建验证
执行：
```bash
npm run build
```
结果：
- 前后端构建通过。

#### 4.2 数据库落库验证
`drizzle push` 在本地因唯一约束提示进入交互，改为 SQL 补齐迁移并验证列存在。

结果：
- `users` 表字段已包含第六步所需所有资料/微信字段。

#### 4.3 接口冒烟验证
执行脚本（`PORT=5107`）验证完整链路：
1. 注册
2. 更新资料
3. 上传头像
4. 微信绑定
5. 发表评论
6. 获取评论列表验证 `userAvatarUrl`
7. 删除测试评论

结果：
- 输出：`STEP6_SMOKE_OK user=phase6_14245 avatar=/uploads/avatars/...png`

---

### 五、验收结论
完成项：
1. [x] 修改个人信息（姓名 + 头像）
2. [x] 头像上传能力
3. [x] 微信绑定字段与后端流程预留
4. [x] 评论头像展示（无头像不展示）
5. [x] 编译与接口链路验证通过

---

### 六、提交记录
1. `7d1295f` - `feat(api): add profile fields, avatar upload, and wechat binding endpoints for phase1 step6`
2. `46c3973` - `feat(web): add profile page and comment avatar display for phase1 step6`

---

### 七、后续建议
1. 将“微信绑定”从开发模拟接口切换为真实 OAuth code 交换流程。
2. 将头像上传从本地磁盘迁移到对象存储（如 COS/S3）并加 CDN。
3. 增加头像压缩与格式校验（尺寸、MIME 白名单、恶意内容扫描）。

---

## 补充任务（2026-02-10）：头像压缩与格式校验（尺寸、MIME 白名单、恶意内容扫描）

### 一、目标
1. 上传头像时对图片进行格式与尺寸校验，拒绝异常/可疑内容。
2. 统一压缩并重编码，降低存储与带宽消耗。
3. 校验失败时稳定返回 JSON（避免前端出现 `Unexpected token '<'`）。

### 二、实现说明
1. 输入约束
   - 允许 MIME：`image/png` / `image/jpeg` / `image/webp` / `image/gif`。
   - 最大原始体积：2MB。
   - 维度范围：最小 64px，最大 4096px（宽高任一超出则拒绝）。
2. 恶意内容扫描（轻量启发式）
   - 对二进制内容做常见脚本/多态文件特征串检查。
   - 对可疑文件头（如 `MZ`/`PK`/`%PDF-`）进行拦截。
3. 压缩与重编码
   - 后端使用 `sharp` 对图片 `rotate + resize(最大边 512) + webp`。
   - 输出限制：<= 512KB；超限则降质量重试，仍超限则拒绝。
4. 错误返回一致性
   - `Zod` 校验错误统一返回 400 JSON：`{ message: "Validation error", issues: [...] }`。

### 三、验证
1. 冒烟测试覆盖
   - 正常图片上传成功，返回 `.webp`。
   - 小尺寸（32x32）被拒绝（400）。
   - 伪造内容（base64 脚本注入）被拒绝（400）。
   - payload 过短触发 `Zod` 校验，也返回 400 JSON（不再返回 HTML 错误页）。
2. 成功输出示例
   - `AVATAR_SECURITY_SMOKE_OK user=phase6sec_port_95958 valid=...webp`

### 四、提交记录
1. `71249e8` - `chore(deps): add sharp for server-side avatar processing`
2. `d1224cc` - `fix(server): return 400 JSON for validation errors`
3. `3f63387` - `fix(avatar): reject MIME mismatches and enforce content type`
