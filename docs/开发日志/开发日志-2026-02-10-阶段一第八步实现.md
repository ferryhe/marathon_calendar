# 开发日志 - 2026-02-10 - 阶段一第八步实现（1.3：混合采集方案补齐 + 管理界面增强）

## 目标
1. 按 `docs/研究报告-数据提取与处理方案.md` 的 2.4 混合方案（最佳实践）补齐“规则优先 → AI 兜底 → 人工复核”的落地路径。
2. 增加管理员自用的数据界面入口，便于观测、调参、复核。
3. 采集配置支持 YAML（首次安装/版本控制），并可导入到 DB 作为运行时配置。
4. 引入 Brave Search 做“赛事发现/绑定”的半自动辅助能力（管理员自用）。

## 设计要点（结论）
- **规则优先**：通用 JSON-LD Event + `sources.config.extract`（CSS selector/attr/regex）。
- **AI 兜底（可选）**：仅当规则提取不到 `raceDate` 时触发；默认关闭；OpenAI 兼容 `chat/completions`。
- **人工复核队列**：`raw_crawl_data.status` 用于标记 `needs_review`，管理员在 `/admin/data` 中集中查看并迭代规则。
- **YAML 配置**：`config/sources.yaml` 作为首次安装与版本控制配置，通过脚本导入 DB（DB 仍是运行时来源）。

## 主要改动
### 1) 混合提取落地（规则 → AI → needs_review）
- 新增：`server/aiExtractor.ts`
  - 环境变量：`AI_API_KEY`、`AI_MODEL`、`AI_BASE_URL`（可选）、`AI_ENABLE_FALLBACK=true`
  - 默认不开启（避免开发环境误烧钱）
- 更新：`server/syncScheduler.ts`
  - `raw_crawl_data` 写入后会更新：
    - `status`: `processed` 或 `needs_review`
    - `processedAt`
    - `metadata.extraction`（method/字段摘要）
    - `metadata.ai`（是否使用 AI、模型、错误信息）
  - 抓取失败会同步写回 `marathon_sources.lastError/nextCheckAt`，便于在管理界面看到失败原因
- 更新：`script/db-ensure-stage1-3-schema.ts`
  - 增加 `raw_crawl_data(status)` 索引，便于按队列状态筛选/检索

### 2) YAML 配置导入
- 新增：`config/sources.yaml`
- 新增：`script/import-sources-yaml.ts`
- 新增脚本：`npm run config:import`

### 3) 管理界面增强 + Discovery
- 新增：`server/braveSearch.ts`
- 新增管理接口：`GET /api/admin/discovery/web-search?q=...`
  - 依赖：`BRAVE_API_KEY`
- 管理界面：`/admin/data` 增加 Discovery（Brave Search）区域

## 验收与验证
### 自动化检查（已通过）
- `npm run check`
- `npm run build`

### 需要你手工验证的点（本地开发环境）
1. 管理界面可用：
   - 设置 `.env`：`ADMIN_API_TOKEN=...`
   - 打开页面：
     ```text
     http://127.0.0.1:5000/admin/data
     ```
   - 输入 token 后能看到 sources/runs/raw/discovery
2. needs_review 队列：
   - 触发一次同步（页面按钮或 `POST /api/admin/sync/run-all`）
   - 检查 Raw Crawl 列表里是否出现 `processed/needs_review`
3. AI 兜底（可选，默认关闭）：
   - 设置 `.env`：
     - `AI_API_KEY=...`
     - `AI_MODEL=...`
     - `AI_ENABLE_FALLBACK=true`
   - 选择一个规则提取不到 `raceDate` 的页面，触发同步后查看 raw 的 `metadata.ai`
4. Brave Search（可选）：
   - 设置 `.env`：`BRAVE_API_KEY=...`
   - 在 `/admin/data` 的 Discovery 区输入关键词，能返回结果列表

## 文档更新
- `docs/项目计划-阶段一-1.3-数据采集与调度-详细计划.md`：按 2.4 混合方案补齐落地说明与里程碑
- `docs/项目计划-完整开发路线图.md`：补充 1.3 子项完成勾选

## 下一步建议
1. 为 `needs_review` 增加“标记已复核/回填字段”的管理接口与 UI（避免只看不改）。
2. 按数据源优先级设计字段级合并策略与冲突处理（官网 > 平台 > 搜索）。
3. 平台源（最酷体育/爱燃烧）先做“列表发现 + 详情页绑定”的半自动流程，再做定时抓取。

