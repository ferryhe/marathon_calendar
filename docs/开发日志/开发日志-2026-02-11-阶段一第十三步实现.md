# 开发日志 - 2026-02-11 - 阶段一第十三步实现（AI 规则模板生成器：raw -> sources.config.extract）

## 目标
1. 从某条 `raw_crawl_data` 一键调用 AI，生成 `sources.config.extract` 的 JSON 模板（selector/attr/regex）。
2. 立即在服务端对 rawContent 进行“模板预览验证”（preview），避免生成后完全不可用。
3. 在 `/admin/data` 的 needs_review 复核弹窗中集成入口，便于“复核 -> 生成规则 -> 迭代配置”。

## 主要改动
### 1) 新增 AI 规则生成模块
- 新增：`server/aiRuleTemplate.ts`
  - `AI_ENABLE_RULE_GEN=true` 时启用（避免误触发产生费用）
  - 使用 OpenAI 兼容 `chat/completions` 接口（沿用 `AI_API_KEY`/`AI_MODEL`/`AI_BASE_URL`）
  - 输出 JSON：
    - `template.extract`：可直接写入 `sources.config.extract`
    - `preview`：把模板应用到 rawContent 后得到的提取结果（含 `raceDateNormalized`）

### 2) 新增 Admin API
- 新增：`POST /api/admin/raw-crawl/:id/ai-rule-template`
  - 输入：rawCrawlId（path）
  - 输出：`template + preview + model`

### 3) 管理后台 UI 集成
- 更新：`client/src/pages/AdminData.tsx`
  - 在 needs_review “复核/回填”弹窗中加入 “AI 规则模板生成器”
  - 生成后展示：
    - preview（raceDateRaw / raceDateNormalized / registrationStatus）
    - 模板 JSON（可编辑）

### 4) 环境变量
- 更新：`.env.example` 增加：
  - `AI_ENABLE_RULE_GEN=false`

## 验收与验证
### 自动化检查（已通过）
- `npm run check`
- `npm run build`

### 需要你手工测试的点
1. 在 `.env` 中配置并开启：
   - `AI_API_KEY=...`
   - `AI_MODEL=...`
   - `AI_ENABLE_RULE_GEN=true`
2. 打开 `/admin/data` -> `needs_review` -> “复核/回填”弹窗
3. 点击 “生成模板”
4. 观察 preview：
   - `raceDateNormalized` 是否能得到 `YYYY-MM-DD`
5. 把模板 JSON 中的 `extract` 复制到对应 Source 的 config（Sources Tab 里），保存后触发一次同步验证（目前需要你手动点“立即同步一次”或按单条 source URL 验证）。

## 已知限制
- 已补齐“一键写入 Source config.extract + 单条同步验证”的闭环：
  - “写入到 Source config”
  - “保存并验证（单条同步）”
- AI 生成的 selector 可能不稳定，建议以 meta/json-ld 等稳定结构为优先。

## 下一步建议
1. 在“保存并验证”后回显本次 run 的状态与 raw/needs_review 结果（当前仅 toast 提示）。
2. 增加“把 AI notes/evidence 附加写入 source.notes 或 config.aiHints”的能力，便于长期维护。
