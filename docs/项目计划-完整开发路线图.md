# 马拉松日历应用项目计划

## 项目概述

### 项目目标
开发一个完整的马拉松日历应用系统，包括Web网页版和微信小程序版本，为跑步爱好者提供全面的马拉松赛事信息查询、评论和管理服务。

### 核心功能
1. 马拉松赛事信息展示（时间、地点、报名状态等）
2. 赛事搜索与筛选
3. 用户评论与评分
4. 微信授权登录
5. 数据自动采集与更新
6. 管理后台

### 技术架构
- **前端**：React + Vite (Web), 微信小程序框架 (Mini Program)
- **后端**：Node.js + Express (现有)
- **数据库**：PostgreSQL (现有)
- **云服务**：腾讯云（统一后台服务）
- **数据采集**：Puppeteer + AI API

## 开发路线图

### 阶段一：Web网页版开发 (优先级：高)

#### 为什么先做Web版？
1. **快速验证**：Web开发周期短，可快速验证产品逻辑
2. **调试方便**：开发和调试比小程序更方便
3. **共享后端**：后端API可以同时服务Web和小程序
4. **SEO优势**：有利于搜索引擎收录，提高曝光度

#### 1.1 前端功能开发

**已完成功能（基于现有代码）：**
- ✅ 基础UI框架 (Radix UI + Tailwind CSS)
- ✅ 路由系统 (Wouter)
- ✅ 状态管理 (TanStack Query)

**待开发功能：**

##### 1.1.1 首页与列表展示
```
功能点：
- [x] 马拉松列表展示（卡片式）
- [x] 日期筛选（按月份、年份；季度待补）
- [x] 地区筛选（省份、城市）
- [x] 报名状态筛选（报名中、即将开始、已结束）
- [x] 关键词搜索
- [ ] 列表排序（按时间、按热度）
- [ ] 分页或无限滚动加载

技术要点：
- 使用TanStack Query进行数据获取和缓存
- 实现虚拟滚动优化性能（如使用react-virtual）
- 响应式设计，适配移动端

时间估计：3-5天
```

##### 1.1.2 赛事详情页
```
功能点：
- [x] 赛事基本信息展示
- [x] 报名链接和报名状态
- [x] 历史举办信息
- [x] 赛事评分和评论展示
- [ ] 相关赛事推荐
- [ ] 分享功能（复制链接、生成海报）

技术要点：
- 使用React Router或Wouter实现路由
- 图片懒加载
- SEO优化（meta标签、结构化数据）

时间估计：2-3天
```

##### 1.1.3 用户评论系统
```
功能点：
- [ ] 评论列表展示
- [ ] 发表评论（需登录）
- [ ] 评分功能（1-5星）
- [ ] 评论点赞
- [ ] 举报不当评论

技术要点：
- 表单验证 (React Hook Form + Zod)
- 乐观更新UI
- 敏感词过滤

时间估计：2-3天
```

##### 1.1.4 用户系统（简化版）
```
功能点：
- [ ] 注册/登录（用户名密码）
- [ ] 用户信息展示
- [ ] 我的评论列表
- [ ] 收藏的赛事
- [ ] 修改个人信息

注：Web版使用简单的用户名密码登录
小程序版后续使用微信授权登录

技术要点：
- 使用现有的Passport.js认证
- JWT或Session管理
- 表单验证

时间估计：3-4天
```

#### 1.2 后端API开发

**已完成（基于现有代码）：**
- ✅ Express服务器框架
- ✅ PostgreSQL数据库连接
- ✅ Drizzle ORM
- ✅ 用户认证（Passport.js）

**待开发API：**

##### 1.2.1 赛事相关API
```
接口列表：
- GET  /api/marathons          - 获取赛事列表（支持筛选、分页）
- GET  /api/marathons/:id      - 获取赛事详情
- GET  /api/marathons/search   - 搜索赛事
- GET  /api/marathons/upcoming - 获取即将举办的赛事
- GET  /api/marathons/hot      - 获取热门赛事

查询参数：
- year: 年份
- month: 月份
- city: 城市
- status: 报名状态
- page: 页码
- limit: 每页数量

时间估计：2天
```

##### 1.2.2 评论相关API
```
接口列表：
- GET    /api/reviews?marathonId=xxx    - 获取赛事评论
- POST   /api/reviews                   - 发表评论（需登录）
- PUT    /api/reviews/:id               - 修改评论（本人）
- DELETE /api/reviews/:id               - 删除评论（本人）
- POST   /api/reviews/:id/like          - 点赞评论

数据验证：
- 评分：1-5整数
- 评论内容：非空，最大1000字
- 敏感词过滤

时间估计：1-2天
```

##### 1.2.3 用户相关API
```
接口列表：
- POST   /api/auth/register     - 注册
- POST   /api/auth/login        - 登录
- POST   /api/auth/logout       - 登出
- GET    /api/users/me          - 获取当前用户信息
- PUT    /api/users/me          - 更新用户信息
- GET    /api/users/me/reviews  - 获取我的评论

时间估计：1-2天
```

#### 1.3 数据采集系统

##### 1.3.1 爬虫模块开发
```
功能点：
- [ ] 核心数据源爬虫（5-10个知名赛事官网）
- [ ] 报名平台爬虫（最酷体育、爱燃烧）
- [ ] 数据去重与合并
- [ ] 增量更新机制
- [ ] 错误处理与重试
- [ ] 爬取日志记录

技术实现：
- 使用Puppeteer处理动态网页
- 使用Cheerio处理静态HTML
- 实现通用的BaseSource类
- 每个数据源继承并实现具体逻辑

代码结构：
crawler/
├── sources/
│   ├── BaseSource.ts          - 基类
│   ├── BeijingMarathon.ts     - 北京马拉松
│   ├── ShanghaiMarathon.ts    - 上海马拉松
│   └── ZuicoolPlatform.ts     - 最酷体育平台
├── parsers/
│   ├── dateParser.ts          - 日期解析
│   ├── locationParser.ts      - 地点解析
│   └── statusParser.ts        - 状态解析
├── scheduler.ts               - 定时任务
└── syncManager.ts             - 同步管理器

时间估计：5-7天
```

##### 1.3.2 AI辅助提取
```
功能点：
- [ ] 集成通义千问API
- [ ] 提示词模板设计
- [ ] AI调用封装（带重试和错误处理）
- [ ] 成本监控和上限控制
- [ ] 传统解析失败时自动调用AI

技术实现：
crawler/ai/
├── aiExtractor.ts             - AI提取器
├── prompts.ts                 - 提示词模板
└── costMonitor.ts             - 成本监控

配置：
- 每日AI调用次数上限
- 单次token上限
- 重试策略
- 降级方案

时间估计：3-4天
```

##### 1.3.3 数据清洗与入库
```
功能点：
- [ ] 数据标准化（日期、地点、名称）
- [ ] 数据验证（必填字段、格式校验）
- [ ] 去重逻辑（基于canonicalName + year）
- [ ] 变更检测（对比现有数据）
- [ ] 批量写入数据库
- [ ] 同步记录日志

实现要点：
- 使用事务保证数据一致性
- 记录原始数据供审计
- 变更通知（可扩展为webhook）

时间估计：3-4天
```

##### 1.3.4 定时任务与监控
```
功能点：
- [ ] 定时任务调度（使用node-cron）
- [ ] 任务执行状态监控
- [ ] 失败告警（邮件或webhook）
- [ ] 性能指标统计
- [ ] 数据质量报告

调度策略：
- 核心赛事：每日检查
- 一般赛事：每周检查
- 已结束赛事：停止检查

时间估计：2-3天
```

#### 1.4 部署与测试

##### 1.4.1 部署配置
```
环境准备：
- [ ] 腾讯云服务器配置
- [ ] PostgreSQL数据库设置
- [ ] Redis缓存设置
- [ ] 域名和SSL证书
- [ ] CI/CD流程（可选）

配置文件：
- 环境变量管理
- 数据库连接配置
- AI API密钥配置

时间估计：1-2天
```

##### 1.4.2 测试
```
测试内容：
- [ ] 单元测试（核心逻辑）
- [ ] API接口测试
- [ ] 爬虫功能测试
- [ ] 端到端测试
- [ ] 性能测试
- [ ] 安全测试

时间估计：3-5天
```

#### 阶段一总计时间：30-40个工作日

---

### 阶段二：微信小程序开发 (优先级：中)

#### 2.1 准备工作

##### 2.1.1 小程序注册与认证
```
步骤：
1. [ ] 注册微信小程序账号
2. [ ] 完成企业/个人认证
3. [ ] 配置服务器域名白名单
4. [ ] 申请必要的接口权限

注意事项：
- 需要营业执照（企业账号）或个人身份证（个人账号）
- 个人账号功能受限（无支付、无附近的小程序等）
- 建议注册企业账号
```

##### 2.1.2 开发环境搭建
```
工具安装：
- [ ] 微信开发者工具
- [ ] Node.js环境（已有）
- [ ] 小程序UI框架选择（推荐：原生 或 Taro）

技术选型：
选项1：原生小程序（推荐）
- 优势：性能最好，官方支持，生态成熟
- 劣势：只能用于微信小程序

选项2：Taro（跨平台）
- 优势：可编译为多端（微信、支付宝、H5等）
- 劣势：性能略差，学习成本

建议：初期使用原生小程序，确保性能和体验
```

#### 2.2 小程序功能开发

##### 2.2.1 页面结构
```
pages/
├── index/              - 首页（赛事列表）
│   ├── index.wxml
│   ├── index.wxss
│   ├── index.js
│   └── index.json
├── detail/             - 赛事详情
├── search/             - 搜索页面
├── user/               - 个人中心
├── reviews/            - 评论列表
└── my-reviews/         - 我的评论

时间估计：5-7天
```

##### 2.2.2 微信授权登录
```
功能实现：
1. [ ] 获取用户授权
2. [ ] 调用wx.login获取code
3. [ ] 后端通过code换取openid
4. [ ] 生成session_key并返回token
5. [ ] 前端存储token用于后续请求

安全要点：
- session_key不能传给前端
- 使用HTTPS传输
- token设置过期时间

API接口：
- POST /api/auth/wechat/login  - 微信登录

时间估计：2-3天
```

##### 2.2.3 核心功能迁移
```
功能列表：
- [ ] 赛事列表展示（复用Web的API）
- [ ] 赛事搜索筛选
- [ ] 赛事详情展示
- [ ] 评论功能
- [ ] 用户个人中心

UI适配：
- 遵循微信小程序设计规范
- 使用WeUI或自定义组件
- 适配不同机型和分辨率

时间估计：8-10天
```

##### 2.2.4 小程序特色功能
```
功能点：
- [ ] 分享功能（分享到微信好友/群）
- [ ] 收藏功能（添加到我的小程序）
- [ ] 订阅消息（赛事提醒、报名开启通知）
- [ ] 地图导航（到赛事地点）
- [ ] 日历导出（添加到手机日历）

技术实现：
- wx.showShareMenu() - 分享
- wx.requestSubscribeMessage() - 订阅消息
- wx.openLocation() - 打开地图
- wx.addPhoneCalendar() - 添加到日历

时间估计：3-4天
```

#### 2.3 后端支持

##### 2.3.1 微信登录API
```
功能实现：
- [ ] 微信登录接口
- [ ] openid绑定用户系统
- [ ] 同一用户多平台关联（Web + 小程序）

技术要点：
- 使用微信官方SDK
- 数据库添加wechat_openid字段
- 支持账号合并

时间估计：2天
```

##### 2.3.2 订阅消息推送
```
功能实现：
- [ ] 订阅消息模板申请
- [ ] 用户订阅记录存储
- [ ] 消息推送逻辑
- [ ] 定时任务触发推送

消息场景：
1. 赛事报名开启提醒
2. 赛事临近提醒（赛前7天、3天、1天）
3. 评论被回复通知

时间估计：2-3天
```

#### 2.4 发布与审核

##### 2.4.1 小程序提交审核
```
准备工作：
- [ ] 完善小程序信息（名称、简介、logo）
- [ ] 设置服务类目
- [ ] 配置隐私政策和用户协议
- [ ] 准备测试账号
- [ ] 准备审核说明文档

注意事项：
- 首次审核可能较慢（3-7天）
- 确保内容合规，无违规内容
- 功能描述清晰准确

时间估计：3-7天（审核等待时间）
```

##### 2.4.2 灰度发布与监控
```
发布策略：
- [ ] 先灰度发布（10% -> 50% -> 100%）
- [ ] 监控错误率和崩溃率
- [ ] 收集用户反馈
- [ ] 快速迭代修复问题

监控工具：
- 微信小程序后台数据分析
- 第三方监控平台（如：阿拉丁、神策）

时间估计：持续进行
```

#### 阶段二总计时间：25-35个工作日

---

### 阶段三：统一后台与数据服务 (优先级：中高)

#### 3.1 腾讯云架构部署

##### 3.1.1 云服务选择
```
推荐配置：

1. 云服务器（CVM）
   - 配置：2核4G / 4核8G
   - 系统：Ubuntu 22.04 LTS
   - 用途：运行Node.js应用

2. 云数据库PostgreSQL
   - 配置：2核4G起
   - 版本：PostgreSQL 14+
   - 特点：自动备份、高可用

3. 对象存储（COS）
   - 用途：存储图片、附件
   - 配置CDN加速

4. Redis缓存
   - 配置：1G内存起
   - 用途：Session、热点数据缓存

5. 内容分发网络（CDN）
   - 用途：加速静态资源访问
   - 适用于Web版和小程序

成本估算：
- 基础配置：约500-800元/月
- 中等配置：约1000-1500元/月
```

##### 3.1.2 统一API网关
```
架构设计：

┌─────────────┐     ┌─────────────┐
│   Web App   │     │  小程序App   │
└──────┬──────┘     └──────┬──────┘
       │                   │
       │    HTTPS请求      │
       └───────┬───────────┘
               ↓
       ┌───────────────┐
       │   腾讯云CDN   │
       └───────┬───────┘
               ↓
       ┌───────────────┐
       │  API Gateway  │  ← 可选：腾讯云API网关
       └───────┬───────┘
               ↓
       ┌───────────────┐
       │ Express Server│
       └───────┬───────┘
               ↓
    ┌──────────┴──────────┐
    │                     │
┌───▼────┐          ┌────▼────┐
│ PostgreSQL│        │  Redis  │
└────────┘          └─────────┘

特点：
- 一套后端服务两端共用
- 统一的数据格式和接口规范
- 集中的权限验证和日志记录

时间估计：2-3天
```

##### 3.1.3 数据库优化
```
优化措施：
- [ ] 添加必要的索引
- [ ] 查询性能优化
- [ ] 配置连接池
- [ ] 设置定期备份
- [ ] 读写分离（可选，后期）

索引建议：
- marathons.canonical_name
- marathon_editions.race_date
- marathon_editions.registration_status
- marathon_reviews.marathon_id
- users.username

时间估计：1-2天
```

#### 3.2 统一用户体系

##### 3.2.1 多端用户关联
```
数据库设计：

users表扩展：
- id: uuid (主键)
- username: string (可选，Web端使用)
- password: string (可选，Web端使用)
- wechat_openid: string (小程序使用)
- wechat_unionid: string (可选，如有多个小程序)
- nickname: string
- avatar_url: string
- created_at: timestamp

关联策略：
1. Web端注册用户可以绑定微信
2. 小程序用户可以设置用户名密码（用于Web登录）
3. 评论和数据在两端同步

时间估计：2天
```

##### 3.2.2 统一认证中间件
```
实现方案：

// middleware/auth.ts
export function authenticateUser(req, res, next) {
  // 1. 检查token（支持JWT或Session）
  // 2. 验证token有效性
  // 3. 根据来源（Web/小程序）使用不同验证逻辑
  // 4. 将用户信息附加到req.user
}

支持的认证方式：
- Session (Web端，已有)
- JWT Token (小程序端)
- 微信临时凭证

时间估计：1-2天
```

#### 3.3 统一数据管理

##### 3.3.1 API接口统一
```
接口规范：

1. 响应格式统一
{
  "success": true,
  "data": {},
  "message": "操作成功",
  "code": 200
}

2. 错误处理统一
{
  "success": false,
  "error": "错误信息",
  "code": 400
}

3. 分页格式统一
{
  "success": true,
  "data": {
    "items": [],
    "total": 100,
    "page": 1,
    "pageSize": 20
  }
}

时间估计：1天（代码重构）
```

##### 3.3.2 缓存策略
```
缓存层级：

1. 浏览器缓存（Web端）
   - 静态资源：max-age=31536000
   - API响应：no-cache

2. CDN缓存
   - 图片、CSS、JS：长期缓存
   - API：不缓存或短期缓存

3. Redis缓存
   - 热门赛事列表：TTL 1小时
   - 赛事详情：TTL 30分钟
   - 用户session：TTL 7天

4. 应用层缓存
   - 数据库查询结果
   - 计算密集型结果

缓存更新策略：
- 数据变更时主动失效
- 定时刷新（后台任务）
- LRU淘汰策略

时间估计：2-3天
```

#### 3.4 监控与运维

##### 3.4.1 应用监控
```
监控指标：
- [ ] API响应时间
- [ ] 错误率统计
- [ ] 数据库查询性能
- [ ] 缓存命中率
- [ ] 爬虫任务成功率

工具选择：
- 腾讯云监控（基础）
- Sentry（错误追踪）
- Grafana + Prometheus（可选，高级监控）

时间估计：2天
```

##### 3.4.2 日志系统
```
日志分类：
- access.log - 访问日志
- error.log - 错误日志
- crawler.log - 爬虫日志
- api.log - API调用日志

日志格式：
- 使用Winston或Pino
- 结构化日志（JSON格式）
- 日志级别：debug, info, warn, error

日志存储：
- 本地文件存储
- 定期归档和清理
- 可选：集中式日志系统（ELK）

时间估计：1-2天
```

#### 阶段三总计时间：15-20个工作日

---

### 阶段四：管理后台与高级功能 (优先级：低)

#### 4.1 管理后台

##### 4.1.1 功能列表
```
- [ ] 用户管理（查看、禁用、删除）
- [ ] 赛事管理（添加、编辑、删除、审核）
- [ ] 评论管理（查看、删除、屏蔽）
- [ ] 数据源管理（添加、配置、测试）
- [ ] 爬虫任务管理（手动触发、查看日志）
- [ ] 系统监控（API统计、性能指标）
- [ ] 配置管理（AI API密钥、调度策略）

时间估计：10-15天
```

##### 4.1.2 权限管理
```
角色设计：
- 超级管理员：所有权限
- 内容管理员：赛事和评论管理
- 运维人员：系统监控和日志查看

权限控制：
- 基于角色的访问控制（RBAC）
- 操作审计日志

时间估计：3-4天
```

#### 4.2 高级功能

##### 4.2.1 智能推荐
```
功能点：
- 基于地理位置推荐附近赛事
- 基于浏览历史推荐相关赛事
- 基于用户评论推荐相似赛事

实现方案：
- 简单版：基于规则（地理位置、时间）
- 高级版：协同过滤、内容推荐算法

时间估计：5-7天
```

##### 4.2.2 社交功能
```
功能点：
- 跑团功能（创建、加入、讨论）
- 赛事约伴（寻找同城跑友）
- 成绩分享（晒成绩、生成海报）
- 训练打卡

注：这些功能可作为后续版本迭代

时间估计：15-20天（后期规划）
```

#### 4.3 数据分析与统计

##### 4.3.1 数据看板
```
统计维度：
- 赛事数量趋势（按月、按季度）
- 地区分布（哪些省份赛事多）
- 报名热度排行
- 用户活跃度分析
- 评论情感分析

可视化：
- 使用Recharts或ECharts
- 地图热力图
- 时间序列图

时间估计：5-7天
```

##### 4.3.2 导出功能
```
功能点：
- 导出赛事列表（Excel）
- 导出统计报表（PDF）
- 数据备份（JSON）

时间估计：2-3天
```

---

## 项目时间规划总览

### 人力配置建议

**方案一：全职开发**
- 1名全栈工程师
- 总工时：约90-110个工作日（4-5个月）

**方案二：团队协作**
- 1名前端工程师 + 1名后端工程师
- 总工时：约50-60个工作日（2.5-3个月）

### 里程碑

| 阶段 | 时间 | 交付内容 |
|-----|------|---------|
| 阶段一 | Month 1-2 | Web版上线，包含核心功能和数据采集 |
| 阶段二 | Month 3 | 小程序版上线 |
| 阶段三 | Month 3-4 | 后台优化，统一数据服务 |
| 阶段四 | Month 5+ | 管理后台和高级功能（持续迭代） |

---

## 技术栈汇总

### 前端
```json
{
  "Web": {
    "框架": "React 19",
    "构建工具": "Vite",
    "路由": "Wouter",
    "状态管理": "TanStack Query",
    "UI库": "Radix UI + Tailwind CSS",
    "表单": "React Hook Form + Zod"
  },
  "小程序": {
    "框架": "微信原生小程序",
    "UI库": "WeUI / 自定义组件"
  }
}
```

### 后端
```json
{
  "运行时": "Node.js 20+",
  "框架": "Express 5",
  "ORM": "Drizzle ORM",
  "数据库": "PostgreSQL 14+",
  "缓存": "Redis",
  "认证": "Passport.js + JWT",
  "日志": "Winston"
}
```

### 数据采集
```json
{
  "爬虫": "Puppeteer + Cheerio",
  "AI服务": "阿里云通义千问 / OpenAI",
  "任务调度": "node-cron",
  "队列": "Bull (Redis-based)"
}
```

### 云服务
```json
{
  "云平台": "腾讯云",
  "服务器": "CVM 云服务器",
  "数据库": "云数据库 PostgreSQL",
  "缓存": "云数据库 Redis",
  "存储": "对象存储 COS",
  "加速": "内容分发网络 CDN"
}
```

---

## 成本估算

### 开发成本
- 人力成本：根据实际情况
- 时间成本：4-5个月（单人）/ 2.5-3个月（团队）

### 运营成本（月度）

| 项目 | 配置 | 费用（元/月） |
|-----|------|-------------|
| 云服务器 | 2核4G | 200-300 |
| 云数据库 | 2核4G | 300-500 |
| Redis | 1G | 100-200 |
| 对象存储+CDN | 100GB流量 | 50-100 |
| AI API（通义千问） | 按调用量 | 30-100 |
| 域名+SSL证书 | 年付分摊 | 10-20 |
| **合计** | | **690-1220** |

注：以上价格为估算，实际价格以云服务商报价为准

### 降成本建议
1. 使用腾讯云学生优惠（如适用）
2. 购买包年套餐享受折扣
3. 合理配置资源，按需扩容
4. 优化AI调用，降低API成本
5. 使用开源方案替代商业服务

---

## 风险评估与应对

### 技术风险

| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| 网站反爬虫 | 高 | 使用代理IP、限制频率、准备降级方案 |
| AI成本超预算 | 中 | 设置上限、优化调用、考虑开源模型 |
| 数据质量问题 | 中 | 多数据源交叉验证、人工审核 |
| 性能瓶颈 | 中 | 缓存优化、数据库优化、CDN加速 |
| 微信审核不通过 | 中 | 提前了解规则、准备替代方案 |

### 业务风险

| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| 数据版权问题 | 高 | 注明数据来源、争取官方授权 |
| 用户增长缓慢 | 中 | 做好内容运营、SEO优化、社交传播 |
| 竞品压力 | 中 | 差异化功能、用户体验优化 |

---

## 总结与建议

### 开发顺序建议
1. **优先开发Web版** - 快速验证产品，建立数据基础
2. **完善数据采集** - 保证数据质量和更新频率
3. **开发小程序版** - 扩大用户触达，利用微信生态
4. **持续优化迭代** - 根据用户反馈不断改进

### 成功关键因素
1. **数据质量**：准确、全面、及时的赛事信息
2. **用户体验**：简洁清晰的界面，流畅的交互
3. **技术稳定**：系统稳定可靠，性能良好
4. **持续运营**：定期更新数据，回应用户反馈

### 后续迭代方向
1. 增加更多数据源，扩大覆盖范围
2. 开发移动端App（iOS/Android）
3. 增加社交功能，建立跑者社区
4. 数据分析和洞察，提供行业报告
5. 商业化探索（广告、会员、增值服务）

---

**项目启动清单：**

- [ ] 确认需求和功能范围
- [ ] 组建开发团队
- [ ] 准备开发环境
- [ ] 注册云服务账号
- [ ] 注册微信小程序账号
- [ ] 申请AI API密钥
- [ ] 制定详细开发计划
- [ ] 开始第一阶段开发！

**祝项目顺利！🎉**
