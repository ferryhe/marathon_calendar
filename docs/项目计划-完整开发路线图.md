# 项目计划 - 完整开发路线图

## 项目目标
构建一个“马拉松赛事日历”应用，支持：
- Web 端赛事浏览、搜索筛选、收藏与评论
-（后续）微信小程序端复用同一套后端 API
-（后续）爬虫自动采集赛事并定期更新

## 技术栈（当前）
- 前端：React + Vite + Radix UI + Tailwind
- 后端：Node.js + Express
- 数据库：PostgreSQL（Drizzle ORM）
- 会话：Session Cookie
- 对象存储：（可选）腾讯云 COS（头像上传已支持 COS/本地双模式）

---

## 阶段一：Web 版（MVP，优先）

### 1.1 前端功能

#### 1.1.1 首页与列表展示
- [x] 马拉松列表展示（卡片/表格）
- [x] 日期筛选（按年/按月）
- [x] 地区筛选（省/市）
- [x] 报名状态筛选
- [x] 关键词搜索
- [x] “我的比赛”筛选（仅展示我收藏的赛事）
- [ ] 列表排序（按时间/热度）
- [ ] 分页或无限滚动

#### 1.1.2 赛事详情页
- [x] 赛事基本信息展示
- [x] 报名链接与报名状态展示
- [x] 历史举办信息（历届 edition）
- [x] 评分与评论展示
- [ ] 相关赛事推荐
- [ ] 分享功能（复制链接/海报等）

#### 1.1.3 用户评论系统
- [x] 评论列表展示
- [x] 发表评论（需登录）
- [x] 评分（1-5）
- [x] 点赞
- [x] 举报

#### 1.1.4 用户系统（简化版）
- [x] 注册/登录（用户名密码）
- [x] 用户信息展示
- [x] 我的评论列表
- [x] 收藏的赛事列表
- [x] 修改个人资料（头像/姓名，微信字段预留）
- [x] 评论区展示作者头像（有则显示，无则不渲染）
- [x] 头像上传安全增强（压缩、尺寸限制、MIME 白名单、恶意内容扫描）

### 1.2 后端 API
（以现有实现为准，文档保持“计划 + 验收口径”）
- [x] 赛事列表/筛选：`GET /api/marathons`
- [x] 赛事详情：`GET /api/marathons/:id`
- [x] 评论：`GET/POST /api/marathons/:id/reviews`、`PUT/DELETE /api/reviews/:id`、`POST /api/reviews/:id/like`、`POST /api/reviews/:id/report`
- [x] 认证：`POST /api/auth/register`、`POST /api/auth/login`、`POST /api/auth/logout`
- [x] 收藏：`GET /api/users/me/favorites`、`POST/DELETE /api/users/me/favorites/:marathonId`、`GET /api/marathons/:id/favorite-status`
- [x] 个人资料：`GET/PUT /api/users/me`、`POST /api/users/me/avatar/upload`

### 1.3 数据采集系统（爬虫 + 调度）
- 详细计划：`docs/项目计划-阶段一-1.3-数据采集与调度-详细计划.md`
- [x] 数据源目录与运行参数（sources 扩展：strategy/isActive/retry/interval/config）
- [x] 赛事-数据源绑定（marathon_sources 扩展：lastHash/nextCheckAt 等）
- [x] 原始抓取内容留存（raw_crawl_data）
- [x] 同步运行记录与可观测性（marathon_sync_runs 扩展：attempt/计数/消息）
- [x] 调度互斥（PG advisory lock，避免多实例重复抓取）
- [x] 增量更新机制（content hash + nextCheckAt/minIntervalSeconds）
- [x] 错误处理与重试（retryMax + backoff + 记录失败原因）
- [x] 管理员专用管理接口（/api/admin/*，token 保护）
- [x] 冒烟验证脚本（Stage 1.3 sync）
- [x] 配置化 HTML 提取规则（sources.config.extract：selector/attr/regex）
- [x] 混合提取策略（规则优先 → AI 兜底（可选） → needs_review 队列）
- [x] 管理界面（/admin/data）
- [x] 管理后台 Tab 分区 + Overview 统计（/api/admin/stats）
- [x] YAML 配置导入（config/sources.yaml + npm run config:import）
- [x] Discovery 搜索（Brave web search：/api/admin/discovery/web-search）
- [x] needs_review 复核回填（raw 明细 + ignore/resolve 接口 + /admin/data UI）
- [x] 字段级合并与冲突处理（官网 > 平台 > 搜索；marathon_editions.field_sources）
- [x] 发布态 Draft/Published（前台默认只展示 published；后台复核后发布）
- [x] AI 规则模板生成器（从 raw 生成 sources.config.extract，并提供 preview 验证）
- [x] 核心数据源爬取（5-10 个知名赛事官网，真实验证+适配）
-  已验证（2026-02-10）：Tokyo / Paris / Boston / Berlin / Chicago（见开发日志）
- [ ] 报名平台爬虫（最酷体育/爱燃烧等）
- [x] 数据去重与合并（canonicalName + year + 优先级/冲突策略）

### 1.4 部署与测试
- [ ] 基础部署脚本与环境规范（Linux 生产）
- [ ] API 冒烟脚本体系化沉淀（可重复运行）
- [ ] 单元测试/接口测试框架（Vitest/Jest/Supertest 等择一）
- [ ] CI（lint/typecheck/build）与发布流程（可选）

---

## 阶段二：微信小程序（中优先级）

### 2.1 准备
- [ ] 小程序账号注册与认证
- [ ] 服务器域名白名单配置
- [ ] 小程序端技术选型（原生 / Taro）

### 2.2 功能
- [ ] 赛事列表/筛选
- [ ] 赛事详情
- [ ] 收藏/我的比赛
- [ ] 评论（含头像展示）
- [ ] 微信登录（与后端联动）

---

## 阶段三：生产化与统一后台
- [ ] 腾讯云部署（CVM/容器化均可）
- [ ] PostgreSQL/Redis 生产配置与备份策略
- [ ] 对象存储 + CDN（静态资源与头像）
- [ ] 日志、监控与告警

---

## 阶段四：增强功能
- [ ] 后台管理（赛事编辑、审核、爬虫监控）
- [ ] 个性化推荐
- [ ] 数据分析与报表

---

## 阶段状态更新（2026-02-10）

### 阶段一完成度说明
当前“阶段一”**未全部完成**，结论如下：
1. 已完成：Web 核心用户功能（列表/详情/评论/认证/收藏/个人资料）
2. 已完成：头像上传安全增强（压缩、尺寸/MIME 白名单、恶意内容扫描）
3. 未完成：数据采集与调度（1.3 仍缺“报名平台爬虫：最酷体育/爱燃烧等”；其余主干已完成）
4. 未完成：部署与系统化测试（1.4 多项）
5. 未完成：部分增强项（如相关赛事推荐、分享功能、分页/无限滚动）

### 阶段切换判定
按现行计划口径，需先完成阶段一剩余项，再正式进入阶段二。
若业务上决定并行推进，可在下一次计划评审中显式确认“阶段二提前启动”。
